<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è–ªè³‡æ˜ç´°æ ¸å°ç³»çµ±</title>
  <style>
    :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --danger: #e74c3c; --info: #3498db; --warning: #f39c12; --bg-gray: #f4f7f6; }
    body { font-family: "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif; background: var(--bg-gray); margin: 0; padding: 15px; color: #333; line-height: 1.5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
    
    h2 { text-align: center; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-top: 0; }
    h3 { border-left: 5px solid var(--info); padding-left: 10px; margin-top: 25px; font-size: 1.1em; color: var(--secondary); }
    
    /* é ‚éƒ¨è³‡è¨Šå¡ */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .info-item label { font-size: 0.85em; color: #666; display: block; }
    .info-item span { font-weight: bold; font-size: 1.1em; }

    /* å¯¦é ˜é‡‘é¡å¤§å­—å ± */
    .net-pay-box { background: #e8f5e9; border-radius: 8px; border: 1px solid var(--accent); padding: 20px; text-align: center; margin-bottom: 20px; }
    .net-pay-box .label { font-size: 1em; color: #666; margin-bottom: 5px; }
    .net-pay-box .val { font-size: 2.2em; font-weight: bold; color: var(--accent); }

    /* å‡ºå‹¤èˆ‡å‡åˆ¥çµ±è¨ˆå¡ç‰‡ */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-card { background: #fff; border: 1px solid #eee; padding: 12px 8px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .stat-card .label { font-size: 0.75em; color: #888; display: block; margin-bottom: 4px; }
    .stat-card .val { font-size: 1.2em; font-weight: bold; color: var(--secondary); }
    .stat-card small { font-size: 0.7em; margin-left: 2px; }

    /* è–ªè³‡çµ„æˆå€å¡Š */
    .detail-section { border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
    .detail-header { background: #f8f9fa; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #eee; font-size: 0.95em; }
    .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px dashed #eee; font-size: 0.95em; }
    .detail-row:last-child { border-bottom: none; }
    .text-plus { color: var(--accent); font-weight: bold; }
    .text-minus { color: var(--danger); font-weight: bold; }
    .item-memo { display: block; font-size: 0.8em; color: #999; font-weight: normal; }

    /* è€ƒå‹¤è¡¨æ ¼ */
    .table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.88em; min-width: 500px; }
    th { background: var(--secondary); color: white; padding: 12px 10px; text-align: left; }
    td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    tr:nth-child(even) { background-color: #fafafa; }
    
    .time-slot { font-family: monospace; font-size: 1.1em; color: #555; line-height: 1.3; }
    .badge { padding: 3px 7px; border-radius: 4px; font-size: 0.75em; font-weight: bold; white-space: nowrap; margin-right: 3px; }
    .badge-late { background: #fff0f0; color: var(--danger); border: 1px solid #ffcaca; }
    .badge-ot { background: #f0fff4; color: var(--accent); border: 1px solid #c6f6d5; }
    .badge-warning { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
    .badge-leave { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
    .badge-normal { background: #f8f9fa; color: #999; border: 1px solid #ddd; }

    /* æ“ä½œå€ */
    .action-area { margin-top: 30px; text-align: center; padding: 25px; border-top: 2px dashed #eee; }
    .btn { padding: 14px 40px; font-size: 1.1em; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; width: 100%; max-width: 320px; box-sizing: border-box; /* åŠ å…¥é€™è¡Œç¢ºä¿ padding ä¸æ’ç ´å¯¬åº¦ */}
    .btn-confirm { background: var(--accent); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
    .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4); }
    .btn-download { background: var(--primary); color: white; text-decoration: none; display: inline-block; margin-top: 15px; }
	
	/* æ–°å¢ï¼šæ‰‹æ©Ÿç«¯è‡ªå‹•ç¸®å°æŒ‰éˆ•èˆ‡å­—é«” */
@media (max-width: 480px) {
  .btn {
    padding: 10px 20px;
    font-size: 0.95em;
    max-width: 100%; /* è®“å®ƒåœ¨æ‰‹æ©Ÿä¸Šæ»¿ç‰ˆä½†å—é™æ–¼ container padding */
  }
  .btn-download {
    margin-top: 10px;
  }
}

    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); display: flex; justify-content:center; align-items:center; z-index:999; flex-direction: column; gap: 10px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--info); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <div id="loadingText">å®‰å…¨æ€§é©—è­‰ä¸­...</div>
</div>

<div class="container" id="mainContainer">
<div style="display: flex; justify-content: flex-start; margin-bottom: 10px;">
    <button onclick="goBackMenu()" style="background: #6c757d; color: white; border: none; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">ğŸ  è¿”å›ä¸»é¸å–®</button>
  </div>
  <h2>è–ªè³‡æ˜ç´°æ ¸å°</h2>
  
  <div class="info-grid">
    <div class="info-item"><label>æ ¸å°æœˆä»½</label><span id="displayYM">----</span></div>
    <div class="info-item"><label>å“¡å·¥å§“å</label><span id="displayName">----</span></div>
  </div>

  <div class="net-pay-box">
    <div class="label">æœ¬æ¬¡å¯¦é ˜ç¸½é¡</div>
    <div class="val">NT$ <span id="netPay">0</span></div>
  </div>

  <h3>å‡ºå‹¤èˆ‡å‡åˆ¥çµ±è¨ˆ</h3>
  <div class="stats-container" id="statsArea">
    <div class="stat-card"><span class="label">æœ¬æœˆç´¯ç©é²åˆ°</span><span class="val" id="statLate">0</span><small>min</small></div>
    <div class="stat-card"><span class="label">æœ¬æœˆç´¯ç©åŠ ç­</span><span class="val" id="statOT">0</span><small>min</small></div>
  </div>

  <h3>è–ªè³‡æ˜ç´° (é‡‘é¡)</h3>
  <div class="detail-section">
    <div class="detail-header">ã€åŠ é …ã€‘æ‡‰é ˜é …ç›®</div>
    <div id="plusItemsArea"></div>
  </div>

  <div class="detail-section">
    <div class="detail-header">ã€æ¸›é …ã€‘æ‡‰æ‰£é …ç›®</div>
    <div id="minusItemsArea"></div>
  </div>

  <h3>å‡ºå‹¤æ˜ç´°èˆ‡æ‰“å¡ç´€éŒ„</h3>
  <div class="table-wrapper">
    <table id="attendanceTable">
      <thead>
        <tr>
          <th width="20%">æ—¥æœŸ/è¨ºåˆ¥</th>
          <th width="25%">åŸå§‹æ‰“å¡</th>
          <th width="25%">ç‹€æ…‹èˆ‡èª¿æ•´</th>
          <th width="30%">å‚™è¨»</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="memoBlock" style="margin-top:20px; background:#fff9db; padding:12px; border-radius:8px; border:1px solid #ffe066; font-size:0.9em; display:none;">
    <strong>çµç®—ç¸½å‚™è¨»ï¼š</strong> <span id="totalMemo"></span>
  </div>

  <div class="action-area" id="actionArea"></div>
</div>

<script>
  // é‡è¦ï¼šæ›´æ›ç‚ºæ‚¨çš„ GAS ç¶²å€
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyaLPGKpUpJP62KqfRgQbuPc-EaJWAAUpwJ8jeYI55eGqxh_kb6xgDGlcyeXyJjtnjdTw/exec";

  let currentUser = {};
  let currentYm = "";

  window.onload = function() {
    const params = new URLSearchParams(window.location.search);
    currentUser = {
        empId: params.get('empId'),
        name: params.get('name')
    };

    // 1. å®‰å…¨æª¢æŸ¥
    if (!currentUser.empId) {
        alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥");
        window.location.href = "index.html";
        return;
    }

    // 2. æœˆä»½è‡ªå‹•åˆ¤å®šï¼šå¦‚æœæœ‰å¸¶ ym ç”¨ ymï¼Œæ²’æœ‰çš„è©±è‡ªå‹•æŠ“ã€Œä¸Šå€‹æœˆã€ (å› ç‚ºé€šå¸¸æ˜¯çµç®—ä¸Šå€‹æœˆè–ªè³‡)
    if (params.get('ym')) {
        currentYm = params.get('ym');
    } else {
        const now = new Date();
        now.setMonth(now.getMonth() - 1); // é è¨­çœ‹ä¸Šå€‹æœˆ
        currentYm = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    loadData();
  };

// è¿”å›ä¸»é¸å–®ä¸¦å¸¶ä¸ŠåŸæœ‰åƒæ•¸
function goBackMenu() {
    const urlParams = new URLSearchParams(window.location.search);
    const empId = urlParams.get('empId');
    const name = urlParams.get('name');
    const role = urlParams.get('role');
    
    // è«‹å°‡ menu.html æ”¹ç‚ºæ‚¨ä¸»é¸å–®çš„å¯¦éš›æª”å
    window.location.href = `index.html?empId=${empId}&name=${encodeURIComponent(name)}&role=${encodeURIComponent(role)}`;
}

  async function loadData() {
    toggleLoading(true, "è®€å–è–ªè³‡è³‡æ–™ä¸­...");
    try {
      const resp = await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getSalaryForAssistant", yearMonth: currentYm, empId: currentUser.empId })
      });
      const res = await resp.json();
      if(res.status === "success") {
        document.getElementById('mainContainer').style.display = 'block';
        renderUI(res.data);
      } else {
        showError(res.message);
      }
    } catch (e) {
      showError("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
    } finally {
      toggleLoading(false);
    }
  }

  function renderUI(data) {
    document.getElementById('displayYM').innerText = currentYm;
    document.getElementById('displayName').innerText = data.empName;
    document.getElementById('netPay').innerText = Number(data.netPay).toLocaleString();
    
    // 1. çµ±è¨ˆå€
    document.getElementById('statLate').innerText = data.totalLateMins || 0;
    document.getElementById('statOT').innerText = data.totalOTMins || 0;
    const statsArea = document.getElementById('statsArea');
    const fixedCards = statsArea.querySelectorAll('.stat-card');
    statsArea.innerHTML = '';
    statsArea.appendChild(fixedCards[0]);
    statsArea.appendChild(fixedCards[1]);

    if(data.leaveSummary) {
      Object.entries(data.leaveSummary).forEach(([name, val]) => {
        if(val > 0) {
          statsArea.innerHTML += `<div class="stat-card"><span class="label">${name}</span><span class="val">${val}</span><small>å¤©</small></div>`;
        }
      });
    }

    // 2. åŠ é …å€
    const plusArea = document.getElementById('plusItemsArea');
    let plusHtml = `<div class="detail-row"><span>å›ºå®šåº•è–ª</span><span class="text-plus">$${Number(data.basePay).toLocaleString()}</span></div>`;
    if(data.otPay > 0) {
      plusHtml += `<div class="detail-row"><span>åŠ ç­æ´¥è²¼ç¸½è¨ˆ</span><span class="text-plus">+$${Number(data.otPay).toLocaleString()}</span></div>`;
    }
    if(data.additions && data.additions.length > 0) {
      data.additions.forEach(item => {
        if(item.name !== "åº•è–ª" && item.name !== "åŠ ç­è²»") {
           plusHtml += `<div class="detail-row">
            <span>${item.name}<small class="item-memo">${item.memo || ''}</small></span>
            <span class="text-plus">+$${Number(item.val).toLocaleString()}</span>
           </div>`;
        }
      });
    }
    plusArea.innerHTML = plusHtml;

    // 3. æ¸›é …å€
    const minusArea = document.getElementById('minusItemsArea');
    let minusHtml = `
      <div class="detail-row"><span>å‹ä¿è‡ªä»˜é¡</span><span class="text-minus">-$${Number(data.labor).toLocaleString()}</span></div>
      <div class="detail-row"><span>å¥ä¿è‡ªä»˜é¡</span><span class="text-minus">-$${Number(data.health).toLocaleString()}</span></div>
    `;
    if(data.lateDeduct > 0) {
      minusHtml += `<div class="detail-row"><span>é²åˆ°æ‰£æ¬¾ç¸½è¨ˆ</span><span class="text-minus">-$${Number(data.lateDeduct).toLocaleString()}</span></div>`;
    }
    if(data.deductions && data.deductions.length > 0) {
      data.deductions.forEach(item => {
        if(!["å‹ä¿æ‰£æ¬¾", "å¥ä¿æ‰£æ¬¾", "é²åˆ°æ‰£æ¬¾"].includes(item.name)) {
          minusHtml += `<div class="detail-row">
            <span>${item.name}<small class="item-memo">${item.memo || ''}</small></span>
            <span class="text-minus">-$${Number(item.val).toLocaleString()}</span>
          </div>`;
        }
      });
    }
    minusArea.innerHTML = minusHtml;

    // 4. è¡¨æ ¼å€
    const tbody = document.querySelector('#attendanceTable tbody');
    tbody.innerHTML = "";
    if(data.attendanceDetails && data.attendanceDetails.length > 0) {
      data.attendanceDetails.forEach(row => {
        let statusBadges = "";
        if (row.status.includes("è«‹å‡")) {
          statusBadges = `<span class="badge badge-leave">${row.status}</span>`;
        } else {
          if (row.late > 0) statusBadges += `<span class="badge badge-late">é²åˆ° ${row.late}m</span> `;
          if (row.ot > 0) statusBadges += `<span class="badge badge-ot">åŠ ç­ ${row.ot}m</span> `;
          if (row.status.includes("ç¼º")) statusBadges += `<span class="badge badge-warning">${row.status}</span> `;
          if (!statusBadges) statusBadges = `<span class="badge badge-normal">æ­£å¸¸</span>`;
        }
		const displayMemo = row.memo || "-";
        const punchInfo = row.status.includes("è«‹å‡") ? "---" : `ä¸Š ${row.actualIn}<br>ä¸‹ ${row.actualOut}`;
        tbody.innerHTML += `<tr>
          <td>${row.date.substring(5)} (${row.shift})</td>
          <td class="time-slot">${punchInfo}</td>
          <td>${statusBadges}</td>
          <td style="color:#666; font-size:0.85em; word-break: break-all;">${displayMemo}</td>
        </tr>`;
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">æœ¬æœˆç„¡æ’ç­æˆ–è€ƒå‹¤ç´€éŒ„</td></tr>`;
    }

    // 5. ç¸½å‚™è¨»
    if(data.memo) {
      document.getElementById('memoBlock').style.display = 'block';
      document.getElementById('totalMemo').innerText = data.memo;
    }

    renderAction(data.confirmStatus, data.slipLink);
  }

  function renderAction(status, slipLink) {
    const area = document.getElementById('actionArea');
    if(status === "å·²ç¢ºèª") {
      area.innerHTML = `
        <div style="color:var(--accent); font-weight:bold; font-size:1.2em; margin-bottom:10px;">âœ… æ‚¨å·²å®Œæˆç·šä¸Šæ ¸å°</div>
        ${slipLink ? `<a class="btn btn-download" href="${slipLink}" target="_blank">æŸ¥çœ‹æ­£å¼è–ªè³‡å–®åœ–æª”</a>` : `<p style="color:#888; font-size:0.85em;">æ­£å¼è–ªè³‡æ¢è£½ä½œä¸­</p>`}
      `;
    } else {
      area.innerHTML = `
        <p style="color:#d63031; font-size:0.9em; margin-bottom:15px;">â€» è«‹æ ¸å°æ‰“å¡æ™‚é–“èˆ‡é‡‘é¡ï¼Œç¢ºèªç„¡èª¤å¾Œé»æ“ŠæŒ‰éˆ•ã€‚</p>
        <button class="btn btn-confirm" onclick="doConfirm()">æœ¬äººå·²æ ¸å°æ˜ç´°ï¼Œç¢ºèªç„¡èª¤</button>
      `;
    }
  }

  async function doConfirm() {
    if(!confirm("ç¢ºå®šè–ªè³‡æ˜ç´°èˆ‡æ‰“å¡ç´€éŒ„çš†æ­£ç¢ºç„¡èª¤å—ï¼Ÿ")) return;
    toggleLoading(true, "æäº¤ç¢ºèªä¸­...");
    try {
      const resp = await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ action: "confirmSalary", yearMonth: currentYm, empId: currentUser.empId })
      });
      const res = await resp.json();
      if(res.status === "success") {
        alert("ç¢ºèªæˆåŠŸï¼");
        location.reload();
      } else {
        alert("å¤±æ•—ï¼š" + res.message);
      }
    } catch (e) {
      alert("é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    } finally {
      toggleLoading(false);
    }
  }

  function toggleLoading(show, text = "è³‡æ–™è®€å–ä¸­...") { 
    document.getElementById('loading').style.display = show ? 'flex' : 'none'; 
    document.getElementById('loadingText').innerText = text;
  }
function showError(msg) { 
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('mainContainer').innerHTML = `
        <div style="padding:40px; text-align:center; color:#666;">
            <div style="font-size: 50px; margin-bottom: 20px;">ğŸ“…</div>
            <h3>ç›®å‰æŸ¥ç„¡çµç®—è³‡æ–™</h3>
            <p style="color: #999;">${msg}</p>
            <button onclick="goBackMenu()" class="btn" style="background:#6c757d; color:white; margin-top:20px;">è¿”å›ä¸»é¸å–®</button>
        </div>`; 
}
</script>

</body>
</html>