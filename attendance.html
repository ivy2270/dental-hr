<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨ºæ‰€è€ƒå‹¤ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        :root { --primary: #28a745; --error: #dc3545; --bg: #f4f7f6; --accent: #007bff; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; touch-action: manipulation; }
        
        .card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 85%; max-width: 320px; text-align: center; }
        .user-info { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
        .user-info h2 { margin: 5px 0; color: var(--primary); font-size: 1.5rem; }
        .user-info p { color: #888; margin: 0; font-size: 0.9rem; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        button { padding: 16px; border: none; border-radius: 12px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        
        .btn-in { background: var(--primary); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2); }
        .btn-out { background: var(--error); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2); }
        .btn-back { background: #eee; color: #666; margin-top: 10px; font-size: 0.9rem; }

        /* éš¨æ©Ÿç¢ºèªæŒ‰éˆ•é®ç½© */
        #randomBtnContainer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; }
        
        /* ä¿®æ”¹æŒ‰éˆ•å¤§å°ç‚ºç›¸å°å–®ä½ï¼Œç¢ºä¿æ‰‹æ©Ÿä¸çˆ†ç‰ˆ */
        #realConfirmBtn { 
            position: absolute; 
            width: 140px; 
            height: 140px; 
            background: #ffc107; 
            color: black; 
            border-radius: 50%; 
            font-weight: bold; 
            border: 4px solid white; 
            font-size: 1rem; 
            cursor: pointer; 
            box-shadow: 0 0 25px rgba(255,193,7,0.5); 
            text-align: center; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.3;
        }

        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div class="card">
        <div class="user-info">
            <p>ç›®å‰ç™»å…¥å“¡å·¥</p>
            <h2 id="displayName">è¼‰å…¥ä¸­...</h2>
            <p id="displayId"></p>
        </div>

        <div class="btn-group">
            <button class="btn-in" onclick="prepareClock('ä¸Šç­')">â˜€ ä¸Šç­æ‰“å¡</button>
            <button class="btn-out" onclick="prepareClock('ä¸‹ç­')">ğŸŒ™ ä¸‹ç­æ‰“å¡</button>
            <button class="btn-back" onclick="goHome()">è¿”å›é¦–é </button>
        </div>
        <p id="statusMsg" style="margin-top: 15px; color: #999; font-size: 0.8rem;">æ‰“å¡å°‡è¨˜éŒ„æ‚¨çš„ä¼ºæœå™¨æ™‚é–“</p>
    </div>

    <div id="randomBtnContainer">
        <button id="realConfirmBtn">
            <span>ç¢ºèª</span>
            <strong id="pendingText" style="font-size: 1.4rem;"></strong>
            <span style="font-size: 0.8rem; margin-top:5px;">(é»æ“Šæ­¤è™•)</span>
        </button>
    </div>

    <div class="loading-overlay" id="loader">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px;">æ‰“å¡å‚³é€ä¸­...</p>
    </div>

    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyaLPGKpUpJP62KqfRgQbuPc-EaJWAAUpwJ8jeYI55eGqxh_kb6xgDGlcyeXyJjtnjdTw/exec";
    let params = {};
    let pendingAction = "";

    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        params = {
            empId: urlParams.get('empId'),
            name: urlParams.get('name')
        };

        if (!params.empId) {
            alert("é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°ç”±å…¥å£ç™»å…¥");
            goHome();
            return;
        }

        $('#displayName').text(params.name);
        $('#displayId').text("å·¥è™Ÿï¼š" + params.empId);
    });

    function prepareClock(action) {
        pendingAction = action;
        $('#pendingText').text(action);
        
        const container = $('#randomBtnContainer');
        const btn = $('#realConfirmBtn');
        
        container.show();
        
        // å–å¾—è¦–çª—å¯¬é«˜
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        
        // å–å¾—æŒ‰éˆ•å¯¬é«˜
        const btnW = btn.outerWidth();
        const btnH = btn.outerHeight();
        
        // è¨­å®šé‚Šè· (é¿å…é é‚Šå¤ªè¿‘æ‰‹æ©Ÿä¸å¥½é»)
        const margin = 20;

        // ç²¾ç¢ºè¨ˆç®—éš¨æ©Ÿç¯„åœ
        const randomX = Math.floor(Math.random() * (winW - btnW - margin * 2)) + margin;
        const randomY = Math.floor(Math.random() * (winH - btnH - margin * 2)) + margin;
        
        btn.css({
            left: randomX + "px",
            top: randomY + "px"
        });
    }

    $('#realConfirmBtn').on('click touchend', async function(e) {
        e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿç«¯è§¸ç™¼å…©æ¬¡
        $('#randomBtnContainer').hide();
        $('#loader').css('display', 'flex');
        
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "logAttendance",
                    empId: params.empId,
                    type: pendingAction
                })
            });
            
            const result = await response.json();
            
            if (result.status === "success") {
                alert(`âœ… ${pendingAction}æ‰“å¡æˆåŠŸï¼`);
                goHome();
            } else {
                alert("âŒ éŒ¯èª¤ï¼š" + result.message);
                $('#loader').hide();
            }
        } catch (e) {
            alert("ç¶²è·¯ä¸ç©©ï¼Œè«‹é‡æ–°å˜—è©¦");
            $('#loader').hide();
        }
    });

    function goHome() {
        window.location.href = "index.html";
    }
</script>
</body>
</html>