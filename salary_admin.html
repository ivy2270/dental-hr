<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åŠ©ç†è–ªè³‡çµç®—ç³»çµ± - ä¸»ç®¡ç«¯</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --light: #f8f9fa; --border: #dee2e6; --purple: #673ab7; --info: #3498db; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f9; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--light); padding-bottom: 15px; }
        .controls { display: flex; gap: 15px; align-items: flex-end; }
        select, input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; background: var(--primary); color: white; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        .confirm-status-bar { padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; display: none; font-weight: bold; text-align: center; }
        .status-confirmed { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; display: block; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: var(--light); padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 12px; color: #666; }
        .stat-card .value { font-size: 22px; font-weight: bold; margin-top: 5px; }
        
        .table-container { max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background-color: #f1f1f1; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--border); }
        td { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 14px; background: white; }
        
        .adjustment-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 10px; background: #fdfdfd; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .net-pay-box { text-align: right; font-size: 28px; font-weight: bold; color: var(--danger); margin-top: 20px; }
        
        .btn-screenshot { background: var(--purple); margin-top: 10px; width: 100%; height: 50px; font-size: 18px; display: none; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .bg-success { background: #d4edda; color: #155724; }
        .bg-danger { background: #f8d7da; color: #721c24; }
        .bg-warning { background: #fff3cd; color: #856404; }
        .edit-min { width: 60px; text-align: center; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        .dynamic-row { display: grid; grid-template-columns: 120px 100px 1fr 40px; gap: 8px; margin-bottom: 8px; }

        /* éš±è—çš„æˆªåœ–å°ˆç”¨å®¹å™¨ */
        #hiddenCaptureContainer { position: absolute; left: -9999px; top: 0; }
        #hiddenAssistantView { width: 800px; background: white; padding: 40px; color: #333; line-height: 1.5; font-family: "Microsoft JhengHei"; }
    
	.header button {
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}
	</style>
</head>
<body>

<div id="loading"><b>æ•¸æ“šè™•ç†ä¸­...</b><p id="loadingMsg" style="margin-top:10px; color:var(--primary); font-weight:bold;"></p></div>

<div class="container" id="mainCaptureArea">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="goBackMenu()" style="background: #6c757d; padding: 5px 12px; font-size: 14px;">ğŸ  è¿”å›ä¸»é¸å–®</button>
        <h2>åŠ©ç†è–ªè³‡çµç®—ç³»çµ± <small style="font-size: 14px; color: #666;">(ä¸»ç®¡çµç®—ä»‹é¢)</small></h2>
    </div>
        <div class="controls">
            æœˆä»½ <input type="month" id="yearMonth" value="2026-02">
            åŠ©ç† <select id="empSelector"><option value="">è¼‰å…¥ä¸­...</option></select>
            <button onclick="fetchPreview()" id="btnFetch">ç”¢ç”Ÿå ±è¡¨</button>
        </div>
    </div>

    <div id="confirmStatusBar" class="confirm-status-bar"></div>

    <div id="resultArea" style="display:none;">
        <div class="stats-grid">
            <div class="stat-card"><h3>æ‡‰å‡ºå‹¤è¨ºæ•¸</h3><div class="value" id="statShifts">0</div></div>
            <div class="stat-card"><h3>ç´¯ç©é²åˆ°(åˆ†)</h3><div class="value" id="statLate">0</div></div>
            <div class="stat-card"><h3>ç´¯ç©åŠ ç­(åˆ†)</h3><div class="value" id="statOT">0</div></div>
            <div class="stat-card" style="border-left-color: #ffc107;"><h3>å‰©é¤˜ç‰¹ä¼‘å¤©æ•¸</h3><div class="value" id="statAL">0</div></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th>æ—¥æœŸ</th><th>è¨ºæ¬¡</th><th>ç‹€æ…‹</th><th>æ‰“å¡æ™‚é–“</th><th>é²åˆ°(åˆ†)</th><th>åŠ ç­(åˆ†)</th><th>å‚™è¨»/èª¿æ•´</th></tr>
                </thead>
                <tbody id="detailsTbody"></tbody>
            </table>
        </div>

        <div class="adjustment-section">
            <div>
                <h4>æ‡‰é ˜é …ç›® (+)</h4>
                <div id="fixedBonusArea"></div>
                <button id="btnAddBonus" onclick="addDynamicRow('addArea', 'plus')" style="background:var(--success); font-size:12px; padding:5px 10px; border-radius:4px;">+ å¢åŠ çé‡‘é …ç›®</button>
                <div id="addArea" style="margin-top:10px;"></div>
            </div>
            <div>
                <h4>æ‰£æ¬¾é …ç›® (-)</h4>
                å‹ä¿æ‰£æ¬¾ <input type="number" id="deductLabor" class="calc-minus" style="width:100px" oninput="calcNet()"><br><br>
                å¥ä¿æ‰£æ¬¾ <input type="number" id="deductHealth" class="calc-minus" style="width:100px" oninput="calcNet()"><br><br>
                é²åˆ°æ‰£æ¬¾ <input type="number" id="deductLate" class="calc-minus" style="width:100px" oninput="calcNet()"><br><br>
                <button id="btnAddDeduct" onclick="addDynamicRow('subArea', 'minus')" style="background:var(--danger); font-size:12px; padding:5px 10px; border-radius:4px;">+ å¢åŠ æ‰£æ¬¾é …ç›®</button>
                <div id="subArea" style="margin-top:10px;"></div>
                
                <div class="net-pay-box">å¯¦é ˜ç¸½é¡ï¼šNT$ <span id="netPayValue">0</span></div>
                
                <div style="margin-top:20px;">
                    <h4>çµç®—å‚™è¨»</h4>
                    <textarea id="settleMemo" style="width:100%; height:60px; padding:10px; border:1px solid #ddd; border-radius:4px; resize:none;"></textarea>
                    <button id="saveBtn" onclick="saveSalaryFinal()" style="width:100%; height:50px; background:var(--primary); font-size:18px; margin-top:10px;">ç¢ºèªçµç®—ä¸¦å„²å­˜</button>
                    <button id="screenshotBtn" class="btn-screenshot" onclick="takeScreenshot()">ğŸ“¸ ç”¢ç”Ÿæ­£å¼è–ªè³‡å–®ä¸¦è‡ªå‹•ä¸Šå‚³</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="hiddenCaptureContainer">
    <div id="hiddenAssistantView">
        <h2 style="text-align: center; color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px;">è–ªè³‡æ ¸å°æ˜ç´° (æ­£å¼å­˜æª”)</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div><label style="color: #666; font-size: 0.9em;">æœˆä»½ï¼š</label><span id="ssYM" style="font-weight:bold;"></span></div>
            <div><label style="color: #666; font-size: 0.9em;">å§“åï¼š</label><span id="ssName" style="font-weight:bold;"></span></div>
        </div>
        <div style="background: #e8f5e9; border: 1px solid #27ae60; padding: 15px; text-align: center; margin-bottom: 20px; border-radius: 8px;">
            <div style="color: #666; font-size: 0.9em;">å¯¦é ˜ç¸½é¡</div>
            <div style="font-size: 2.2em; font-weight: bold; color: #27ae60;">NT$ <span id="ssNetPay"></span></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                <h4 style="margin: 0 0 10px 0; color: #27ae60; border-bottom: 1px solid #eee;">æ‡‰é ˜é …ç›®</h4>
                <div id="ssPlusArea"></div>
            </div>
            <div style="border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                <h4 style="margin: 0 0 10px 0; color: #e74c3c; border-bottom: 1px solid #eee;">æ‰£æ¬¾é …ç›®</h4>
                <div id="ssMinusArea"></div>
            </div>
        </div>
        <h4 style="border-left: 5px solid #3498db; padding-left: 10px;">å‡ºå‹¤æ˜ç´°</h4>
        <div style="display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.85em; background: #f0f7ff; padding: 10px; border-radius: 5px;">
            <span>ç´¯ç©é²åˆ°ï¼š<b id="ssLate"></b> åˆ†</span>
            <span>ç´¯ç©åŠ ç­ï¼š<b id="ssOT"></b> åˆ†</span>
            <span>å‰©é¤˜ç‰¹ä¼‘ï¼š<b id="ssAL"></b> å¤©</span>
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px;">
            <thead style="background: #34495e; color: white;">
                <tr><th style="padding: 6px;">æ—¥æœŸ/è¨ºæ¬¡</th><th style="padding: 6px;">æ‰“å¡æ™‚é–“</th><th style="padding: 6px;">ç‹€æ…‹</th><th style="padding: 6px;">å‚™è¨»</th></tr>
            </thead>
            <tbody id="ssTableBody"></tbody>
        </table>
        <div id="ssMemoBlock" style="padding: 10px; background: #fff9db; border: 1px solid #ffe066; border-radius: 5px; font-size: 0.85em;">
            <strong>çµç®—å‚™è¨»ï¼š</strong> <span id="ssTotalMemo"></span>
        </div>
        <div style="margin-top: 15px; text-align: right; font-size: 10px; color: #999;">ç³»çµ±ç”¢å‡ºæ™‚é–“ï¼š<span id="ssGenTime"></span></div>
    </div>
</div>

<script>
// è«‹æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„æœ€æ–° Web App URL
const API = "https://script.google.com/macros/s/AKfycbyaLPGKpUpJP62KqfRgQbuPc-EaJWAAUpwJ8jeYI55eGqxh_kb6xgDGlcyeXyJjtnjdTw/exec"; 

let allEmps = [];
let bonusCols = [];
let currentUser = null; // æ–°å¢ï¼šå„²å­˜ç•¶å‰æ“ä½œä¸»ç®¡è³‡è¨Š

window.onload = async () => {
    // --- 1. æ¬Šé™èˆ‡ç™»å…¥é©—è­‰ (æ–°å¢çš„éƒ¨åˆ†) ---
    const urlParams = new URLSearchParams(window.location.search);
    const loginEmpId = urlParams.get('empId'); // ç™»å…¥è€…çš„ ID
    const loginName = urlParams.get('name');   // ç™»å…¥è€…çš„å§“å
    const loginRole = urlParams.get('role');   // ç™»å…¥è€…çš„è§’è‰²

    // å®‰å…¨æª¢æŸ¥ï¼šè‹¥éä¸»ç®¡/Admin å‰‡é€€å›ä¸»é¸å–®
    if (!loginEmpId || (loginRole !== "ä¸»ç®¡" && loginRole !== "Admin")) {
        alert("æ¬Šé™ä¸è¶³ï¼Œè«‹ç”±æ­£è¦ç®¡ç†å…¥å£ç™»å…¥");
        window.location.href = "index.html"; // å‡è¨­æ‚¨çš„é¦–é æ˜¯ index.html
        return;
    }
    
    // å„²å­˜ç›®å‰ä¸»ç®¡è³‡è¨Š
    currentUser = { id: loginEmpId, name: loginName, role: loginRole };

    // åœ¨æ¨™é¡Œæ—é‚Šé¡¯ç¤ºæ“ä½œè€… (å„ªåŒ–é«”é©—)
    const headerTitle = document.querySelector('.header h2');
    if(headerTitle) {
        headerTitle.innerHTML += ` <span style="font-size:12px; color:var(--primary); font-weight:normal;">[æ“ä½œè€…: ${loginName}]</span>`;
    }

    // --- 2. åŸæœ¬çš„åˆå§‹åŒ–é‚è¼¯ (é–‹å§‹åŸ·è¡Œ) ---
    try {
        const r = await fetch(API, { 
            method: 'POST', 
            body: JSON.stringify({ action: "getSalaryInitData" }) 
        });
        const res = await r.json();
        allEmps = res.employees;
        bonusCols = res.bonusColumns;
        document.getElementById('empSelector').innerHTML = '<option value="">è«‹é¸æ“‡åŠ©ç†...</option>' + 
            allEmps.map(e => `<option value="${e.id}">${e.name} (${e.id})</option>`).join('');
    } catch(e) { 
        console.error("åˆå§‹åŒ–å¤±æ•—:", e); 
        alert("ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    }
};

// è¿”å›ä¸»é¸å–®ä¸¦å¸¶ä¸ŠåŸæœ‰åƒæ•¸
function goBackMenu() {
    const urlParams = new URLSearchParams(window.location.search);
    const empId = urlParams.get('empId');
    const name = urlParams.get('name');
    const role = urlParams.get('role');
    
    // å°å‘ä¸»é¸å–® (è«‹ç¢ºä¿ä¸»é¸å–®æª”åç‚º main_menu.html æˆ– index.html)
    // ä¸¦æŠŠåƒæ•¸é‡æ–°å¸¶å›å»ï¼Œé€™æ¨£ä¸»é¸å–®æ‰èƒ½è¾¨è­˜èº«åˆ†
    window.location.href = `index.html?empId=${empId}&name=${encodeURIComponent(name)}&role=${encodeURIComponent(role)}`;
}

async function fetchPreview() {
    const ym = document.getElementById('yearMonth').value;
    const eid = document.getElementById('empSelector').value;
    if(!eid) return alert("è«‹é¸æ“‡åŠ©ç†");
    
    document.getElementById('loading').style.display = 'flex';
    resetUI();
    
    try {
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({ action: "getSalaryPreview", yearMonth: ym, empId: eid }) });
        const res = await r.json();
        if(res.status === "success") {
            render(res.data[0]);
            checkConfirmStatus(res.data[0].confirmStatus);
        } else {
            alert("è¼‰å…¥å¤±æ•—ï¼š" + res.message);
        }
    } catch(e) { alert("é€£ç·šéŒ¯èª¤"); }
    document.getElementById('loading').style.display = 'none';
}

function checkConfirmStatus(status) {
    const isConfirmed = (status === "å·²ç¢ºèª");
    const statusBar = document.getElementById('confirmStatusBar');
    const saveBtn = document.getElementById('saveBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');
    
    if (isConfirmed) {
        statusBar.innerText = "âœ… åŠ©ç†å·²å®Œæˆæ ¸å° (è³‡æ–™é–å®šä¸­)";
        statusBar.className = "confirm-status-bar status-confirmed";
        saveBtn.style.display = "none";
        screenshotBtn.style.display = "block";
        screenshotBtn.disabled = false;
        screenshotBtn.innerText = "ğŸ“¸ ç”¢ç”Ÿæ­£å¼è–ªè³‡å–®ä¸¦è‡ªå‹•ä¸Šå‚³";
        screenshotBtn.style.background = ""; // æ¢å¾©ç´«è‰²
        lockInputs(true);
    } else {
        statusBar.style.display = "none";
        saveBtn.style.display = "block";
        screenshotBtn.style.display = "none";
        lockInputs(false);
    }
}

function lockInputs(shouldLock) {
    const elements = document.querySelectorAll('#resultArea input, #resultArea textarea, #resultArea button:not(#screenshotBtn)');
    elements.forEach(el => el.disabled = shouldLock);
}

function resetUI() {
    document.getElementById('addArea').innerHTML = '';
    document.getElementById('subArea').innerHTML = '';
    document.getElementById('fixedBonusArea').innerHTML = '';
    document.getElementById('resultArea').style.display = 'none';
}

function render(data) {
    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('statAL').innerText = data.remainingAL || 0;
    document.getElementById('statShifts').innerText = data.details.length;
    
    document.getElementById('detailsTbody').innerHTML = data.details.map(row => {
        let cls = row.status.includes('æ—©æ—©é€€') || row.status.includes('è«‹å‡') ? 'bg-warning' : (row.status.includes('ç¼º') ? 'bg-danger' : 'bg-success');
        return `<tr data-date="${row.date}" data-shift="${row.shift}">
                <td>${row.date.split('-')[2]}æ—¥</td><td>${row.shift}</td><td><span class="status-badge ${cls}">${row.status}</span></td><td>${row.actualIn}~${row.actualOut}</td>
                <td><input type="number" class="edit-min late-val" value="${row.late}" oninput="syncMinutes()"></td>
                <td><input type="number" class="edit-min ot-val" value="${row.ot}" oninput="syncMinutes()"></td>
                <td><input type="text" class="edit-memo" value="${row.historyMemo || ''}" style="width:120px; padding:4px;"></td></tr>`;
    }).join('');

    // æ‰¾åˆ°è©²åŠ©ç†åœ¨ Employee_Master ä¸­çš„åŸå§‹è¨­å®š
    const emp = allEmps.find(e => e.id.toString() === data.empId.toString()) || {};
    const saved = data.savedDetails;

    // --- ä¿®æ”¹ï¼šåº•è–ªä»£å…¥é‚è¼¯ ---
    // å¦‚æœæœ‰å„²å­˜é(saved)ï¼Œç”¨å„²å­˜çš„éŒ¢ï¼›å¦‚æœæ²’å„²å­˜éï¼Œç”¨ç¸½è¡¨(emp)è¨­å®šçš„åº•è–ª
    let currentBasePay = saved ? saved.basePay : (emp.basePay || 0);
    
    let fixedHtml = `åº•è–ª <input type="number" class="calc-plus" id="basePay" data-label="åº•è–ª" value="${currentBasePay}" style="width:100px; margin-bottom:10px;" oninput="calcNet()"><br>`;
    fixedHtml += `åŠ ç­è²» <input type="number" class="calc-plus" id="otPay" data-label="åŠ ç­è²»" value="${saved ? saved.otPay : 0}" style="width:100px; margin-bottom:10px;" oninput="calcNet()"><br>`;
    
    bonusCols.forEach(col => {
        let val = emp.dynamicBonuses ? (emp.dynamicBonuses[col] || 0) : 0;
        if (saved?.additions) { 
            const match = saved.additions.find(a => a.name === col); 
            if (match) val = match.val; 
        }
        fixedHtml += `${col} <input type="number" class="calc-plus" data-label="${col}" value="${val}" style="width:100px; margin-bottom:10px;" oninput="calcNet()"><br>`;
    });
    document.getElementById('fixedBonusArea').innerHTML = fixedHtml;

    // --- ä¿®æ”¹ï¼šå‹å¥ä¿ä»£å…¥é‚è¼¯ ---
    // é‚è¼¯åŒåº•è–ªï¼šå„ªå…ˆå–å·²å­˜è³‡æ–™ï¼Œå¦å‰‡å–ç¸½è¡¨é è¨­å€¼
    document.getElementById('deductLabor').value = saved ? saved.labor : (emp.insLabor || 0);
    document.getElementById('deductHealth').value = saved ? saved.health : (emp.insHealth || 0);
    document.getElementById('deductLate').value = saved ? saved.lateDeduct : 0;
    
    // å‚™è¨»éƒ¨åˆ†ï¼šå¦‚æœæ˜¯èˆŠè³‡æ–™ï¼Œé¡¯ç¤ºåŸæœ¬çš„å‚™è¨»ï¼›å¦‚æœæ˜¯æ–°ç”¢ç”Ÿçš„ï¼Œå…ˆç•™ç©º
    document.getElementById('settleMemo').value = saved ? (saved.memo || "") : "";

    if (saved) {
        saved.additions.forEach(item => { 
            if (item.name !== "åº•è–ª" && item.name !== "åŠ ç­è²»" && !bonusCols.includes(item.name)) 
                addDynamicRow('addArea', 'plus', item.name, item.val, item.memo); 
        });
        saved.deductions.forEach(item => { 
            if (!["å‹ä¿æ‰£æ¬¾", "å¥ä¿æ‰£æ¬¾", "é²åˆ°æ‰£æ¬¾"].includes(item.name)) 
                addDynamicRow('subArea', 'minus', item.name, item.val, item.memo); 
        });
    }
    syncMinutes(); // é€™æœƒè§¸ç™¼ calcNet ä¸¦è¨ˆç®—å¯¦é ˜é‡‘é¡
}

function syncMinutes() {
    let l = 0, o = 0;
    document.querySelectorAll('.late-val').forEach(el => l += Number(el.value)||0);
    document.querySelectorAll('.ot-val').forEach(el => o += Number(el.value)||0);
    document.getElementById('statLate').innerText = l;
    document.getElementById('statOT').innerText = o;
    calcNet();
}

function addDynamicRow(areaId, type, name = "", val = 0, memo = "") {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `<input type="text" placeholder="åç¨±" value="${name}"><input type="number" class="calc-${type}" value="${val}" oninput="calcNet()"><input type="text" placeholder="å‚™è¨»" value="${memo}"><span style="cursor:pointer; color:red;" onclick="this.parentElement.remove();calcNet();">âœ•</span>`;
    document.getElementById(areaId).appendChild(div);
    calcNet();
}

function calcNet() {
    let p = 0, m = 0;
    document.querySelectorAll('.calc-plus').forEach(el => p += Number(el.value)||0);
    document.querySelectorAll('.calc-minus').forEach(el => m += Number(el.value)||0);
    document.getElementById('netPayValue').innerText = Math.round(p - m).toLocaleString();
}

// ğŸ“¸ æˆªåœ–èˆ‡è‡ªå‹•ä¸Šå‚³å‡½å¼ (æ•´åˆå„ªåŒ–ç‰ˆ)
async function takeScreenshot() {
    const ym = document.getElementById('yearMonth').value;
    const eid = document.getElementById('empSelector').value;
    const empName = document.getElementById('empSelector').selectedOptions[0].text;
    const sBtn = document.getElementById('screenshotBtn');
    const target = document.getElementById('hiddenAssistantView');

    // --- 1. åŒæ­¥æ•¸æ“šè‡³éš±è—ç‰ˆå‹ ---
    document.getElementById('ssYM').innerText = ym;
    document.getElementById('ssName').innerText = empName;
    document.getElementById('ssNetPay').innerText = document.getElementById('netPayValue').innerText;
    document.getElementById('ssLate').innerText = document.getElementById('statLate').innerText;
    document.getElementById('ssOT').innerText = document.getElementById('statOT').innerText;
    document.getElementById('ssAL').innerText = document.getElementById('statAL').innerText;
    document.getElementById('ssTotalMemo').innerText = document.getElementById('settleMemo').value;
    document.getElementById('ssGenTime').innerText = new Date().toLocaleString();

    // æ¸²æŸ“è¡¨æ ¼å…§å®¹
    let tableHtml = "";
    document.querySelectorAll('#detailsTbody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const late = tr.querySelector('.late-val').value;
        const ot = tr.querySelector('.ot-val').value;
        const memo = tr.querySelector('.edit-memo').value;
        let statusDisplay = cells[2].innerText;
        if(late > 0) statusDisplay += ` <span style="color:red">(é²${late})</span>`;
        if(ot > 0) statusDisplay += ` <span style="color:green">(åŠ ${ot})</span>`;
        tableHtml += `<tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 8px;">${cells[0].innerText} (${cells[1].innerText})</td>
            <td style="padding: 8px;">${cells[3].innerText}</td>
            <td style="padding: 8px;">${statusDisplay}</td>
            <td style="padding: 8px; color: #666;">${memo || '-'}</td></tr>`;
    });
    document.getElementById('ssTableBody').innerHTML = tableHtml;

    // æ¸²æŸ“æ‡‰é ˜é …ç›®
    let plusHtml = "";
    document.querySelectorAll('.calc-plus').forEach(el => {
        const label = el.dataset.label || el.parentElement.querySelector('input[type="text"]').value;
        const val = Number(el.value) || 0;
        if(val !== 0) plusHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${label}</span><span>$${val.toLocaleString()}</span></div>`;
    });
    document.getElementById('ssPlusArea').innerHTML = plusHtml;

    // æ¸²æŸ“æ‰£æ¬¾é …ç›®
    let minusHtml = "";
    const deductItems = [
        { label: 'å‹ä¿æ‰£æ¬¾', val: document.getElementById('deductLabor').value }, 
        { label: 'å¥ä¿æ‰£æ¬¾', val: document.getElementById('deductHealth').value }, 
        { label: 'é²åˆ°æ‰£æ¬¾', val: document.getElementById('deductLate').value }
    ];
    deductItems.forEach(item => { 
        const val = Number(item.val) || 0; 
        if(val !== 0) minusHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${item.label}</span><span>-$${val.toLocaleString()}</span></div>`; 
    });
    document.querySelectorAll('#subArea .dynamic-row').forEach(row => { 
        const ins = row.querySelectorAll('input'); 
        const val = Number(ins[1].value) || 0; 
        if(val !== 0) minusHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${ins[0].value}</span><span>-$${val.toLocaleString()}</span></div>`; 
    });
    document.getElementById('ssMinusArea').innerHTML = minusHtml;

    // --- 2. æº–å‚™æˆªåœ–ç’°å¢ƒ (è§£æ±ºæ»‘æ¡¿èˆ‡æ¨™é¡ŒéŒ¯ä½) ---
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingMsg').innerText = "æ­£åœ¨ç”¢ç”Ÿé•·åœ–ä¸¦ä¸Šå‚³è‡³é›²ç«¯...";
    sBtn.disabled = true;
    sBtn.innerText = "â³ è™•ç†ä¸­...";

    // æš«æ™‚ä¿®æ”¹æ¨£å¼ä»¥åˆ©é•·æˆªåœ–
    const originalPosition = target.parentElement.style.position;
    const ths = target.querySelectorAll('th');
    
    // å¼·åˆ¶å°‡éš±è—å®¹å™¨å±•é–‹ï¼Œä¸¦é—œé–‰ Sticky
    target.style.height = 'auto';
    target.style.overflow = 'visible';
    ths.forEach(th => { th.style.position = 'static'; }); 

    try {
        // åŸ·è¡Œæˆªåœ–
        const canvas = await html2canvas(target, { 
            scale: 2,           // æé«˜æ¸…æ™°åº¦
            useCORS: true,      // å…è¨±è·¨åŸŸåœ–ç‰‡
            backgroundColor: "#ffffff",
            windowHeight: target.scrollHeight // æ•æ‰å®Œæ•´æ²å‹•é«˜åº¦
        });

        // æ¢å¾©æ¨£å¼
        ths.forEach(th => { th.style.position = 'sticky'; });
        target.style.height = ''; 
        target.style.overflow = '';

        const base64Data = canvas.toDataURL("image/png").split(',')[1];

        // --- 3. ç™¼é€è‡³ GAS ä¸Šå‚³ ---
        const response = await fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                action: "uploadSalarySlip",
                yearMonth: ym,
                empId: eid,
                base64Data: base64Data
            })
        });
        
        const res = await response.json();
        
        if(res.status === "success") {
            alert("âœ… è–ªè³‡å–®æˆªåœ–å·²æˆåŠŸä¸Šå‚³é›²ç«¯ï¼Œä¸¦å›å¯«è‡³ S æ¬„ï¼");
            sBtn.innerText = "âœ… å·²æˆåŠŸä¸Šå‚³";
            sBtn.style.background = "var(--success)";
        } else {
            alert("âŒ ä¸Šå‚³å¤±æ•—ï¼š" + res.message);
            sBtn.disabled = false;
            sBtn.innerText = "ğŸ“¸ ç”¢ç”Ÿæ­£å¼è–ªè³‡å–®ä¸¦è‡ªå‹•ä¸Šå‚³";
        }
    } catch (e) {
        console.error("æˆªåœ–/ä¸Šå‚³éŒ¯èª¤:", e);
        alert("ç³»çµ±å‡ºéŒ¯ï¼š" + e.toString());
        sBtn.disabled = false;
        sBtn.innerText = "ğŸ“¸ ç”¢ç”Ÿæ­£å¼è–ªè³‡å–®ä¸¦è‡ªå‹•ä¸Šå‚³";
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loadingMsg').innerText = "";
    }
}


async function saveSalaryFinal() {
    const empId = document.getElementById('empSelector').value;
    const ym = document.getElementById('yearMonth').value;
    
    // 1. åŸºæœ¬æª¢æŸ¥
    if (!empId) return alert("è«‹å…ˆé¸æ“‡åŠ©ç†");
    if (!confirm(`ç¢ºèªå„²å­˜æ­¤æœˆä»½ (${ym}) çš„çµç®—è³‡æ–™ï¼Ÿ`)) return;

    // 2. é¡¯ç¤ºè®€å–ä¸­
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('loadingMsg').innerText = "æ­£åœ¨å„²å­˜çµç®—è³‡æ–™...";

    // 3. æŠ“å–ç•«é¢ä¸Šçš„é‡‘é¡æ•¸å€¼
    const net = document.getElementById('netPayValue').innerText.replace(/,/g, '');

    // è™•ç†æ‡‰é ˜é …ç›® (åŠ é …)
    const additions = [];
    document.querySelectorAll('.calc-plus').forEach(el => {
        const val = Number(el.value) || 0;
        // å›ºå®šæ¬„ä½ç”¨ data-labelï¼Œå‹•æ…‹æ¬„ä½å¾å‰é¢çš„ input text æŠ“åç¨±
        let name = el.dataset.label || el.parentElement.querySelector('input[type="text"]').value;
        // å‹•æ…‹æ¬„ä½å¯èƒ½æœ‰å‚™è¨»ï¼Œå›ºå®šæ¬„ä½(å¦‚åº•è–ª)å‰‡ç„¡
        let memoInput = el.parentElement.querySelectorAll('input')[2];
        let memo = memoInput ? memoInput.value : "";
        if (name) additions.push({ name, val, memo });
    });

    // è™•ç†æ‰£æ¬¾é …ç›® (æ¸›é …)
    const deductions = [];
    deductions.push(
        { name: "å‹ä¿æ‰£æ¬¾", val: Number(document.getElementById('deductLabor').value) || 0 },
        { name: "å¥ä¿æ‰£æ¬¾", val: Number(document.getElementById('deductHealth').value) || 0 },
        { name: "é²åˆ°æ‰£æ¬¾", val: Number(document.getElementById('deductLate').value) || 0 }
    );
    document.querySelectorAll('#subArea .dynamic-row').forEach(row => {
        const ins = row.querySelectorAll('input');
        deductions.push({ name: ins[0].value, val: Number(ins[1].value) || 0, memo: ins[2].value });
    });

    // è™•ç†æ¯æ—¥ç´°ç¯€èª¿æ•´ (é²åˆ°ã€åŠ ç­ã€æ—¥å‚™è¨»)
    const dailyAdjusts = {};
    document.querySelectorAll('#detailsTbody tr').forEach(tr => {
        const date = tr.dataset.date;
        const shift = tr.dataset.shift;
        dailyAdjusts[`${date}_${shift}`] = {
            late: tr.querySelector('.late-val').value,
            ot: tr.querySelector('.ot-val').value,
            memo: tr.querySelector('.edit-memo').value
        };
    });

    // 4. è™•ç†å‚™è¨»ï¼šåµŒå…¥è¨ˆè–ªä¸»ç®¡è³‡è¨Š
    const originalMemo = document.getElementById('settleMemo').value;
    let finalMemo = originalMemo;
    const operatorTag = `[çµç®—ä¸»ç®¡: ${currentUser.name}]`;
    
    // å¦‚æœåŸå§‹å‚™è¨»é‚„æ²’åŒ…å«é€™å€‹ä¸»ç®¡æ¨™ç±¤ï¼Œå°±åŠ ä¸Šå»
    if (!originalMemo.includes(operatorTag)) {
        finalMemo = `${operatorTag} ${originalMemo}`.trim();
    }

    // 5. ç™¼é€è‡³å¾Œç«¯ API
    try {
        const r = await fetch(API, { 
            method: 'POST', 
            body: JSON.stringify({ 
                action: "saveSalaryFinal", 
                yearMonth: ym, 
                empId: empId, 
                dailyAdjustments: JSON.stringify(dailyAdjusts),
                details: {
                    basePay: document.getElementById('basePay').value,
                    labor: document.getElementById('deductLabor').value,
                    health: document.getElementById('deductHealth').value,
                    lateDeduct: document.getElementById('deductLate').value,
                    otPay: document.getElementById('otPay').value,
                    additions: additions, 
                    deductions: deductions, 
                    netPay: net,
                    memo: finalMemo // ä½¿ç”¨çµ„åˆäº†ä¸»ç®¡å§“åçš„å‚™è¨»
                }
            }) 
        });
        
        const res = await r.json();
        
        if (res.status === "success") {
            alert("âœ… çµç®—å„²å­˜æˆåŠŸï¼");
            // å„²å­˜å¾Œé‡æ–°æ•´ç†é è¦½ç•«é¢ï¼Œä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
            await fetchPreview();
        } else {
            alert("âŒ å„²å­˜å¤±æ•—ï¼š" + res.message);
        }
    } catch (e) {
        console.error("Save Error:", e);
        alert("âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API è¨­å®š");
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loadingMsg').innerText = "";
    }
}
</script>
</body>
</html>
