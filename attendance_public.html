<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ‰€å…¬ç”¨æ‰“å¡çœ‹æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --error: #dc3545; --bg: #f8f9fa; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; height: 95vh; }
        
        /* åŠ©ç†åå–®é¸æ“‡å€ */
        .staff-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 10px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            max-height: 40vh; overflow-y: auto;
        }
        .staff-btn { 
            padding: 12px 5px; border: 2px solid #eee; border-radius: 8px; background: white;
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .staff-btn.active { border-color: var(--primary); background: #e7f1ff; color: var(--primary); transform: translateY(-2px); }

        /* æ‰“å¡æŒ‰éˆ• */
        .action-area { 
            display: flex; gap: 10px; align-items: center; 
            padding: 15px; background: #fff; border-radius: 12px;
        }
        .btn-clock { 
            flex: 1; padding: 18px; border: none; border-radius: 10px; 
            color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; opacity: 0.3; pointer-events: none;
        }
        .btn-clock.enabled { opacity: 1; pointer-events: auto; }
        .btn-in { background: var(--success); }
        .btn-out { background: var(--error); }

        /* æ‰“å¡å‹•æ…‹å€ (éœæ…‹é¡¯ç¤ºæœ€æ–°æ“ä½œ) */
        .log-section { flex: 1; background: white; border-radius: 12px; padding: 15px; overflow: hidden; display: flex; flex-direction: column; }
        .log-list { flex: 1; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px; }
        .log-item { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: white; margin-right: 5px; }

        /* éš¨æ©Ÿç¢ºèªæŒ‰éˆ• */
        #randomBtnOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; }
        #realConfirmBtn { position: absolute; width: 110px; height: 110px; background: #ffc107; border: 4px solid #fff; border-radius: 50%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin: 5px 0;">ğŸ¥ è¨ºæ‰€åŠ©ç†æ‰“å¡ç³»çµ±</h3>
    
    <div id="staffGrid" class="staff-grid">åå–®è¼‰å…¥ä¸­...</div>

    <div class="action-area">
        <div id="selectedDisplay" style="width:70px; font-weight:bold; color:var(--primary);">è«‹é¸äºº</div>
        <button id="btnIn" class="btn-clock btn-in" onclick="startClock('ä¸Šç­')">â˜€ ä¸Šç­</button>
        <button id="btnOut" class="btn-clock btn-out" onclick="startClock('ä¸‹ç­')">ğŸŒ™ ä¸‹ç­</button>
    </div>

    <div class="log-section">
        <div style="font-weight:bold; color:#666;">ä»Šæ—¥æ‰“å¡ç´€éŒ„ (æœ¬æ¬¡é–‹å•ŸæœŸé–“)</div>
        <div id="logList" class="log-list"></div>
    </div>
</div>

<div id="randomBtnOverlay">
    <button id="realConfirmBtn">ç¢ºèªæ‰“å¡</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxIzIUEMUkN2iWjKnYbdq-6znGrxFF7gajztQnSrsWto9BeeT-c98yooTk75OPMP7Qitw/exec";
    let selectedEmp = null;
    let pendingAction = "";
    let localLogs = []; // æš«å­˜æ‰“å¡ç´€éŒ„

    $(document).ready(function() {
        loadStaffList();
    });

    // 1. åˆ©ç”¨ç¾æœ‰çš„ getSalaryInitData æŠ“åŠ©ç†åå–®
    async function loadStaffList() {
        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "getSalaryInitData" })
            });
            const result = await res.json();
            if (result.status === "success") {
                // ç¯©é¸å‡º Role ç‚ºåŠ©ç†çš„äºº (æˆ–æ ¹æ“šæ‚¨çš„ Role åç¨±èª¿æ•´)
                const assistants = result.employees.filter(e => e.role === "åŠ©ç†");
                renderStaff(assistants);
            }
        } catch (e) { alert("ç„¡æ³•å–å¾—åå–®"); }
    }

    function renderStaff(list) {
        const html = list.map(s => `
            <button class="staff-btn" onclick="selectStaff('${s.id}', '${s.name}', this)">
                ${s.name}
            </button>
        `).join('');
        $('#staffGrid').html(html);
    }

    function selectStaff(id, name, btn) {
        selectedEmp = { id, name };
        $('.staff-btn').removeClass('active');
        $(btn).addClass('active');
        $('#selectedDisplay').text(name);
        $('.btn-clock').addClass('enabled');
    }

    // 2. è§¸ç™¼éš¨æ©ŸæŒ‰éˆ•
    function startClock(type) {
        pendingAction = type;
        const overlay = $('#randomBtnOverlay');
        const btn = $('#realConfirmBtn');
        overlay.show();
        
        const winW = $(window).width() - 120, winH = $(window).height() - 120;
        btn.css({ left: Math.random() * winW + 20 + "px", top: Math.random() * winH + 20 + "px" });
        btn.html(`${type}<br>${selectedEmp.name}<br>é»æˆ‘`);
    }

    // 3. å‘¼å«ç¾æœ‰çš„ logAttendance å¯«å…¥è³‡æ–™
    $('#realConfirmBtn').click(async function() {
        $('#randomBtnOverlay').hide();
        const emp = selectedEmp; 
        const act = pendingAction;

        try {
            const res = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "logAttendance",
                    empId: emp.id,
                    type: act
                })
            });
            const result = await res.json();
            
            if (result.status === "success") {
                // éœé»˜æ›´æ–°ï¼šå°‡æˆåŠŸç´€éŒ„åŠ å…¥å‰ç«¯åˆ—è¡¨
                const newLog = { name: emp.name, type: act, time: result.time };
                localLogs.unshift(newLog); // å€’åºï¼šæ”¾åœ¨æœ€å‰é¢
                renderLogs();
                
                // é‡ç½®é¸æ“‡ç‹€æ…‹
                $('.staff-btn').removeClass('active');
                $('.btn-clock').removeClass('enabled');
                $('#selectedDisplay').text("è«‹é¸äºº");
                selectedEmp = null;
            }
        } catch (e) { alert("æ‰“å¡å¤±æ•—"); }
    });

    function renderLogs() {
        const html = localLogs.map(l => `
            <div class="log-item">
                <span><b>${l.name}</b></span>
                <span><span class="tag" style="background:${l.type==='ä¸Šç­'?'#28a745':'#dc3545'}">${l.type}</span></span>
                <span style="color:#888;">${l.time}</span>
            </div>
        `).join('');
        $('#logList').html(html);
    }
</script>
</body>
</html>