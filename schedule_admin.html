<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰™é†«è¨ºæ‰€é€±æ’ç­ç³»çµ± - å°ˆæ¥­ç®¡ç†ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    :root { 
        --primary: #007bff; --success: #28a745; --error: #dc3545; --border: #dee2e6; 
        --morning: #007bff; --afternoon: #28a745; --evening: #fd7e14;
        --dr-bg: #495057; --staff-bg: #28a745; --view-bg: #fdf6e3;
    }
    * { box-sizing: border-box; }
    body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
    
    /* --- å´é‚Šæ¬„ (æ¡Œæ©Ÿé è¨­) --- */
    .sidebar { width: 190px; background: white; border-right: 1px solid var(--border); padding: 12px; flex-shrink: 0; display: flex; flex-direction: column; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
    .staff-item { padding: 8px; margin-bottom: 8px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: grab; font-size: 13px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: background 0.2s; }
    .staff-item:hover { background: #f8f9fa; border-color: var(--primary); }
    .staff-header { display: flex; justify-content: space-between; align-items: center; }
    .count-badge { color: white; border-radius: 3px; padding: 1px 4px; font-size: 10px; font-weight: bold; }
    .bg-safe { background: var(--success); }
    .bg-danger { background: var(--error); }
    .bg-neutral { background: #adb5bd; }
    .leave-warn { color: var(--error); font-size: 10px; display: block; margin-top: 2px; font-weight: bold; }

    /* --- ä¸»å€åŸŸ (æ¡Œæ©Ÿé è¨­) --- */
    .main-content { flex-grow: 1; padding: 12px; display: flex; flex-direction: column; overflow-x: auto; }
    .version-bar { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
    .ver-btn { padding: 5px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; flex-shrink: 0; transition: all 0.2s; }
    .ver-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .ver-btn.active { background: #ffc107; border-color: #ffc107; font-weight: bold; color: #000; }

    /* --- ç­è¡¨å®¹å™¨ (æ¡Œæ©Ÿæ©«æ’) --- */
    .weekly-container { display: flex; gap: 10px; flex-grow: 1; width: 100%; }
    .day-column { width: calc(100% / 6); background: #fff; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; min-width: 165px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .day-header { background: #343a40; color: white; padding: 10px 5px; text-align: center; font-size: 14px; font-weight: bold; border-top-left-radius: 7px; border-top-right-radius: 7px; }
    .day-header small { font-size: 10px; display: block; opacity: 0.8; margin-top: 2px; font-weight: normal; }
    .day-content { display: block; } /* æ¡Œæ©Ÿç‰ˆé è¨­å…¨é–‹ */
    
    .read-only-mode .day-column { background: var(--view-bg); }

    /* è¨ºæ¬¡æ¨£å¼ */
    .shift-section { padding: 6px; border-left: 4px solid #ddd; margin-bottom: 5px; }
    .shift-morning { border-left-color: var(--morning); background: rgba(0,123,255,0.02); }
    .shift-afternoon { border-left-color: var(--success); background: rgba(40,167,69,0.02); }
    .shift-evening { border-left-color: var(--evening); background: rgba(253,126,20,0.02); }
    .shift-title { font-size: 11px; font-weight: 800; color: #666; display: flex; justify-content: space-between; padding: 2px 4px; margin-bottom: 4px; }
    
    .slot-box { margin-bottom: 4px; border: 1px solid #e9ecef; border-radius: 4px; background: #fff; display: flex; align-items: stretch; overflow: hidden; min-height: 40px; }
    .dr-name-label { width: 45px; background: #f8f9fa; color: #333; padding: 4px; font-weight: bold; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; line-height: 1.2; border-right: 1px solid #e9ecef; flex-shrink: 0; position: relative; }
    .slot-disabled { opacity: 0.6; background: #f1f3f5 ; }

    .drop-zone { flex-grow: 1; min-height: 38px; padding: 4px; display: flex; flex-wrap: wrap; gap: 4px; align-content: flex-start; }
    .staff-tag { background:var(--staff-bg); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .remove { cursor: pointer; margin-left: 5px; font-weight: bold; font-size: 14px; padding: 2px 10px !important; display: inline-block;}

    .day-leave-area { background: #f8f9fa; padding: 8px; font-size: 11px; border-top: 1px solid var(--border); height: 90px; overflow-y: auto; }
    .leave-title { font-size: 10px; color: #adb5bd; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .leave-item { color: #495057; padding: 2px 0; border-bottom: 1px solid #eee; }

    /* å…¬ç”¨å…ƒä»¶ */
    button { font-size: 12px; cursor: pointer; border-radius: 6px; border: none; transition: opacity 0.2s; }
    button:active { opacity: 0.7; }
    .btn-main { background: var(--primary); color: white; padding: 10px; font-weight: bold; width: 100%; margin-top: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* Overlay æ¨£å¼ */
    #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 10001; display: none; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #loginOverlay { position: fixed; inset: 0; background: #212529; z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .login-card { background: white; padding: 25px; border-radius: 16px; width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .pattern-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .dot { width: 55px; height: 55px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; transition: all 0.2s; }
    .dot.active { background: var(--primary); color: white; transform: scale(1.1); }

    #copyModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10002; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-body { background: white; padding: 25px; border-radius: 12px; width: 320px; max-height: 80vh; overflow-y: auto; }
	
	/* éš±è—çš„è¼¸å‡ºå®¹å™¨ï¼Œç¢ºä¿ä¸å½±éŸ¿ä½¿ç”¨è€…ç•«é¢ */
#hiddenRenderArea {
    position: absolute;
    left: -9999px;
    top: -9999px;
}

/* A4 ç•«å¸ƒæ¨£å¼ */
.a4-print-canvas {
    width: 1123px; /* A4 æ©«å‘åƒç´  */
    height: 794px;
    background: white;
    padding: 30px;
    display: flex;
    gap: 10px;
}

.print-col {
    flex: 1;
    border: 1px solid #ddd;
    display: flex;
    flex-direction: column;
}

.print-day-header {
    background: #f8f9fa;
    padding: 10px;
    text-align: center;
    border-bottom: 2px solid #333;
    font-weight: bold;
}

.print-shift-section {
    flex: 1;
    padding: 5px;
    border-bottom: 1px solid #eee;
}

.print-shift-title {
    font-size: 12px;
    font-weight: bold;
    color: #666;
    margin-bottom: 5px;
}

.print-slot {
    background: #f0f0f0;
    margin-bottom: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 13px;
}

.print-staff-tag {
    display: inline-block;
    background: var(--staff-bg);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    margin-left: 5px;
}

    /* =========================================
       æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– (è¢å¹•å¯¬åº¦ < 768px)
       ========================================= */
    @media (max-width: 768px) {
        body { flex-direction: column; }
        
        .main-content { 
            flex: 1; height: auto; overflow-y: auto; 
            padding: 10px; padding-bottom: 250px; /* é ç•™åº•éƒ¨ç©ºé–“ */
            display: flex; flex-direction: column; 
        }

        /* æ­·å²å¿«ç…§æ©«å¹…ä¸ç¸®å° */
        .view-banner { flex-shrink: 0; }
        .version-bar { flex-shrink: 0; min-height: 60px; margin: 0 0 10px 0; }

        /* åº•éƒ¨å›ºå®šå´é‚Šæ¬„ */
        .sidebar { 
            width: 100%; height: auto; position: fixed; bottom: 0; left: 0; 
            background: #fff; padding: 10px; z-index: 1001; 
            box-shadow: 0 -3px 10px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column;
			overflow: visible !important;			
        }

        /* éš±è—æ‰‹æ©Ÿç‰ˆæ¨™é¡Œ */
        #adminInfo, .sidebar > div:first-child { display: none ; }

#staffPool {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important; /* å¼·åˆ¶ä¸æ›è¡Œ */
        overflow-x: auto !important;  /* æ˜ç¢ºé–‹å•Ÿæ©«å‘æ²è»¸ */
        overflow-y: hidden;           /* é—œé–‰å‚ç›´æ²è»¸ */
		touch-action: pan-x !important;
        -webkit-overflow-scrolling: touch;
        min-height: 50px;             /* çµ¦æ²è»¸ç•™å‡ºç©ºé–“ */
		gap: 10px !important;         
        padding: 10px 5px !important;
    }
    .staff-item {
        flex-shrink: 0 !important;    /* é—œéµï¼šé˜²æ­¢å¯¬åº¦è¢«å£“ç¸® */
        min-width: 110px;
		margin: 0 !important;
		
    }
}
		.count-badge {
            font-size: 9px;
            padding: 1px 3px;
            line-height: 1;
        }

        /* ç¢ºä¿åŠ©ç†æ± å…§çš„æ–‡å­—èˆ‡æ•¸å­—åœ¨ä¸€è¡Œå…§ */
        .staff-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        /* æœˆæ›†å®¹å™¨ (ä¸­é–“) */
        #datePickerContainer { margin: 5px 0; padding: 5px ; display: block; }
        
/* æŒ‰éˆ•å€ (æœ€ä¸‹å±¤) ä¿®æ­£ */
        .sidebar > div:last-child { 
            display: flex; 
            gap: 5px; 
            margin-top: 5px; 
            align-items: stretch; /* å¼·åˆ¶å­å…ƒç´ (æŒ‰éˆ•)æ‹‰ä¼¸å¡«æ»¿é«˜åº¦ */
        }

        .btn-main { 
            margin-top: 0 !important; 
            flex: 1; 
            height: 42px; /* æ˜ç¢ºæŒ‡å®šé«˜åº¦ï¼Œç¢ºä¿ä¸‰å€‹æŒ‰éˆ•ä¸€æ¨¡ä¸€æ¨£é«˜ */
            padding: 0 5px; /* æ¸›å°‘å…§è·ï¼Œè®“æ–‡å­—åœ¨çª„è¢å¹•ä¹Ÿèƒ½é¡¯ç¤º */
            font-size: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            white-space: normal; /* è‹¥æŒ‰éˆ•å­—æ•¸éå¤šï¼Œå…è¨±å…§éƒ¨æ›è¡Œä½†ç¶­æŒç¸½é«˜åº¦ */
        }

        /* ç­è¡¨å‚ç›´æ’åˆ—èˆ‡æŠ˜ç–Š */
        .weekly-container { flex-direction: column; }
        .day-column { width: 100%; min-width: unset; margin-bottom: 10px; }
        .day-content { display: none; } /* æ‰‹æ©Ÿç‰ˆé è¨­éš±è— */
        .day-column.active .day-content { display: block; }

        /* ç®­é ­å‚ç›´ç½®ä¸­ */
        .day-header { cursor: pointer; position: relative; padding: 15px; }
        .day-header::after { 
            content: 'â–¼'; position: absolute; right: 20px; 
            top: 50%; transform: translateY(-50%); 
            font-size: 12px; opacity: 0.5; 
        }
        .day-column.active .day-header::after { content: 'â–²'; }
        
        .dr-name-label { width: 55px; font-size: 12px; }
    }
</style>
</head>
<body id="appBody">

<div id="loadingOverlay"><div class="spinner"></div><p>è™•ç†ä¸­...</p></div>

<div id="copyModal">
    <div class="modal-body">
        <h4 style="margin-top:0;">é¸æ“‡æ­·å²é€±ç‰ˆæœ¬</h4>
        <div id="copyVersionList"></div>
        <button onclick="document.getElementById('copyModal').style.display='none'" style="margin-top:15px; width:100%; padding:10px; background:#6c757d; color:white;">å–æ¶ˆ</button>
    </div>
</div>

<div class="sidebar">
    <div id="adminInfo" style="font-size:14px; margin-bottom:10px; color:var(--primary); font-weight:bold; text-align:center;"></div>
    
    <div id="staffPool"></div>

    <div id="datePickerContainer" style="background:#f8f9fa; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #eee;">
        <label style="font-size:10px; color:#999; display:block; margin-bottom:4px;">é¸æ“‡é€±ä¸€æ—¥æœŸ</label>
        <input type="date" id="mondayPicker" onchange="fetchData()" style="width:100%; font-size:13px; border:1px solid #ddd; padding:5px; border-radius:4px;">
    </div>
    
    <div style="margin-top:10px;">
        <button onclick="openCopyModal()" class="btn-main" style="background:#6f42c1; margin-bottom:8px;">å¾æ­·å²é€±è¤‡è£½</button>
        <button id="btnSave" onclick="saveSchedule()" class="btn-main" style="background:var(--success)">ç™¼ä½ˆç­è¡¨</button>
        <button id="btnExitView" onclick="fetchData()" class="btn-main" style="background:var(--error); display:none;">çµæŸé è¦½</button>
		<button onclick="showImageOptions()" class="btn-main" style="background: #fd7e14; margin-bottom: 8px;">
    ç”¢ç”Ÿç­è¡¨åœ–å¡
</button>
		<button onclick="window.location.href='index.html'" class="btn-main" style="background:#6c757d;">â¬… è¿”å›ç³»çµ±é¸å–®</button>
    </div>
</div>

<div class="main-content">
    <div class="view-banner" id="viewBanner" style="background:#ffc107; text-align:center; font-weight:bold; padding:6px; border-radius:4px; margin-bottom:10px; font-size:13px; display:none;">âš ï¸ ç›®å‰æ­£åœ¨æŸ¥çœ‹æ­·å²ç‰ˆæœ¬ï¼ˆå”¯è®€ï¼‰</div>
    <div class="version-bar" id="versionSlider">
        <span style="font-size:12px; font-weight:bold; color:#555;">æœ¬é€±å¿«ç…§ï¼š</span>
        <div id="verButtons" style="display:flex; gap:8px;"></div>
    </div>
    <div class="weekly-container" id="weeklyGrid"></div>
</div>

<div id="printOptionModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:100000; display:none; align-items:center; justify-content:center;">
    <div style="background:white; padding:25px; border-radius:15px; width:300px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">é¸æ“‡è¼¸å‡ºæ¨¡å¼</h3>
        <p style="color:#666; font-size:14px; margin-bottom:20px;">è«‹é¸æ“‡é©åˆçš„åœ–ç‰‡æ¨£å¼</p>
        
        <button onclick="execPrint('color')" class="btn-main" style="background:#fd7e14; margin-bottom:12px; width:100%;">ğŸŒˆ å½©è‰² (é©åˆ LINE/è¢å¹•æŸ¥çœ‹)</button>
        <button onclick="execPrint('bw')" class="btn-main" style="background:#495057; margin-bottom:12px; width:100%;">ğŸ–¨ï¸ é»‘ç™½ (é©åˆç´™æœ¬åˆ—å°)</button>
        
        <button onclick="document.getElementById('printOptionModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer; font-size:14px; text-decoration:underline;">å–æ¶ˆ</button>
    </div>
</div>

<div id="imagePreviewModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:99999; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:95%; max-height:80%; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; text-align:center; color:#333;">é€±ç­è¡¨åœ–å¡é è¦½ (A4æ©«å‘)</h3>
        <div id="canvasContainer" style="border:1px solid #ccc; line-height:0;"></div>
        <p style="color:#666; font-size:13px; text-align:center; margin-top:10px;">â€» è‹¥ç„¡æ³•ä¸‹è¼‰ï¼Œè«‹é•·æŒ‰åœ–ç‰‡é¸æ“‡ã€Œå„²å­˜åœ–ç‰‡ã€</p>
    </div>
    <div style="margin-top:20px; display:flex; gap:15px;">
        <button id="downloadBtn" class="btn-main" style="background:#28a745; width:150px; cursor:pointer;">ğŸ’¾ ä¸‹è¼‰åœ–ç‰‡</button>
        <button onclick="document.getElementById('imagePreviewModal').style.display='none'" class="btn-main" style="background:#6c757d; width:150px; cursor:pointer;">âŒ é—œé–‰é è¦½</button>
    </div>
</div>

<div id="renderTempArea" style="position:absolute; left:-9999px; top:-9999px;"></div>

<script>
    // JS é‚è¼¯å®Œå…¨ä¿ç•™ï¼Œä¿®å¾©é¡è‰²é¡¯ç¤º Bug èˆ‡é†«å¸«æ·±ç°è‰²æ¨™ç±¤
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxIzIUEMUkN2iWjKnYbdq-6znGrxFF7gajztQnSrsWto9BeeT-c98yooTk75OPMP7Qitw/exec";
    let appData = null;
    let currentUser = null;
    let isReadOnly = false;
    let sortables = [];

    // --- å·¥å…·å‡½æ•¸ ---

    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

    function formatDate(d) {
        if(!d) return "";
        const date = new Date(d);
        return isNaN(date.getTime()) ? d : `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    // æ ¹æ“šåŠ©ç† ID ç”¢ç”Ÿå›ºå®šä¸”ç¾è§€çš„ HSL é¡è‰²
function getStaffColor(empId) {
    if (!empId) return '#adb5bd';
    const str = String(empId);
    let hash = 0;
    
    // 1. ä½¿ç”¨è³ªæ•¸ 31 ä¾†æ”¾å¤§å­—å…ƒé–“çš„å·®ç•°
    for (let i = 0; i < str.length; i++) {
        hash = (hash * 31) + str.charCodeAt(i);
        hash = hash & hash; // è½‰ç‚º 32ä½å…ƒæ•´æ•¸
    }

    // 2. ä½¿ç”¨ã€Œé»ƒé‡‘æ¯”ä¾‹æ¨å°å‡ºçš„æ•¸å€¼ã€ä¾†åˆ†ä½ˆè‰²ç›¸ï¼Œé€™èƒ½è®“ç›¸é„°çš„ ID è·³è½‰åˆ°å®Œå…¨ä¸åŒçš„è‰²å€
    // 137.5 åº¦æ˜¯è‘—åçš„é»ƒé‡‘è§’åº¦ï¼Œèƒ½æœ‰æ•ˆæ‰“æ•£é¡è‰²
    const h = Math.abs(hash * 137.5) % 360;
    
    // 3. ç¨å¾®èª¿æ•´äº®åº¦ï¼Œè®“é¡è‰²æ›´æœ‰å±¤æ¬¡æ„Ÿ
    return `hsl(${h}, 65%, 40%)`;
}
    // é†«å¸«è«‹å‡æª¢æŸ¥
    function checkDrLeave(n, d, sh) { 
        if (!appData || !appData.drLeaves) return null;
        const leave = appData.drLeaves.slice(1).find(l => 
            l[1] === n && 
            formatDate(l[2]) === d && 
            (l[3] === sh || l[3] === 'å…¨å¤©')
        );
        return leave ? leave[4] : null; 
    }

    // åŠ©ç†è«‹å‡æª¢æŸ¥
    function checkStaffLeave(empId, dateStr, currentShift) {
        if (!appData.staffLeaves) return null;
        const leave = appData.staffLeaves.slice(1).find(l => {
            const isSameId = l[0].toString() === empId.toString();
            const isSameDate = formatDate(l[2]) === dateStr;
            const leaveShift = l[3]; 
            const isSameShift = (leaveShift === currentShift || leaveShift === 'å…¨å¤©');
            return isSameId && isSameDate && isSameShift;
        });
        return leave ? `${leave[3]}:${leave[4]}` : null; 
    }

    // --- ç³»çµ±æ ¸å¿ƒæµç¨‹ ---

    function initSystem() {
        const today = new Date();
        const diff = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1);
        const monday = new Date(today.setDate(diff));
        document.getElementById('mondayPicker').value = formatDate(monday);
        fetchData();
    }

    async function fetchData() {
        showLoading(true);
        isReadOnly = false;
        toggleViewMode(false);
        const monday = document.getElementById('mondayPicker').value;
        try {
            const res = await fetch(webAppUrl, { method: "POST", body: JSON.stringify({ action: "getScheduleInitData", targetMonday: monday }) });
            appData = await res.json();
            renderStaffPool(); 
            renderSchedule();
            fetchSnapshots(monday);
        } finally { showLoading(false); }
    }

    function renderSchedule() {
        const currentWeekDates = appData.weekDates.map(d => formatDate(d));
        const hasSavedData = appData.liveSchedule && appData.liveSchedule.length > 1 && 
            appData.liveSchedule.slice(1).some(row => {
                const rowDate = formatDate(row[0]);
                return currentWeekDates.includes(rowDate) && row[2] !== "";
            });

        const grid = document.getElementById('weeklyGrid');
        const shifts = [ {n: "æ—©", c: "morning"}, {n: "åˆ", c: "afternoon"}, {n: "æ™š", c: "evening"} ];
        const dayNames = ["é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        sortables = []; 

        grid.innerHTML = appData.weekDates.map((dateStr, i) => {
            const currentFormattedDate = formatDate(dateStr);
            const holiday = appData.holidays ? appData.holidays.find(h => formatDate(h[0]) === currentFormattedDate) : null;
            const isClinicClosed = holiday && holiday[2] === 'No';

            return `
                <div class="day-column" onclick="handleDayClick(this, event)">
                    <div class="day-header">${dayNames[i]}<small>${currentFormattedDate}</small></div>
                    <div class="day-content">
                        <div style="flex-grow:1; overflow-y:auto; padding:4px;">
                            ${isClinicClosed ? '<div style="text-align:center; padding:30px; color:#adb5bd; font-size:13px;">ğŸ¨ æœ¬æ—¥ä¼‘è¨º</div>' : 
                              shifts.map(sh => `
                                <div class="shift-section shift-${sh.c}" data-date="${currentFormattedDate}" data-shift="${sh.n}">
                                    <div class="shift-title">
                                        <span>${sh.n}è¨º</span>
                                        <button style="color:var(--primary); background:none; font-weight:bold; padding:0;" onclick="event.stopPropagation(); addExtraSlotPrompt(${i+1},'${sh.n}','${currentFormattedDate}')">+ åŠ è¨º</button>
                                    </div>
                                    <div class="slot-container">${renderSlots(i+1, sh.n, currentFormattedDate, hasSavedData)}</div>
                                </div>
                              `).join('')}
                        </div>
                        <div class="day-leave-area">${renderDayLeaves(currentFormattedDate)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        initSortable();
        fillExistingData();
        updateCounts();
    }

    function renderSlots(day, shift, dateStr, hasSavedData) {
        const slots = appData.template.slice(1).filter(t => t[1] == day && t[2] == shift);
        const empMap = {}; 
        appData.employees.forEach(e => empMap[e[0]] = e[1]);

        return slots.map(s => {
            const drName = s[4];
            const pos = s[5];
            const defaultId = s[6];
            const isPublic = s[3] !== "é†«å¸«é€£å‹•";
            const leaveReason = checkDrLeave(drName, dateStr, shift[0]); 
            
            let defaultStaffTag = "";
            if (defaultId && !leaveReason && !hasSavedData) {
                const staffColor = getStaffColor(defaultId);
                defaultStaffTag = `
    <div class="staff-tag" data-id="${defaultId}" style="background-color: ${staffColor}; color: white; border: none;">
        ${empMap[defaultId] || defaultId} 
        <span class="remove" 
              onclick="event.stopPropagation(); this.parentElement.remove(); updateCounts();"
              ontouchend="event.stopPropagation(); this.parentElement.remove(); updateCounts();">Ã—</span>
    </div>`;
            }
            return createSlotHTML(drName, pos, isPublic, leaveReason, dateStr, day, shift, false, defaultStaffTag);
        }).join('');
    }

function createSlotHTML(drName, pos, isPublic, leaveReason, dateStr, day, shift, isExtra, defaultTag = "") {
    const isDisabled = !isPublic && leaveReason !== null;
    const labelStyle = isPublic 
        ? 'background:#e9ecef; color:#666;' 
        : 'background:var(--dr-bg); color:white;';

    return `
        <div class="slot-box ${isDisabled ? 'slot-disabled' : ''}">
            <div class="dr-name-label" style="${labelStyle} position:relative;">
                <span>${isPublic ? pos : drName}</span>
                ${isDisabled ? `<span class="dr-leave-note" ...>${leaveReason}</span>` : ''}
                ${isExtra ? `
                    <span class="remove" 
                          onclick="event.stopPropagation(); this.closest('.slot-box').remove(); updateCounts();" 
                          ontouchend="event.stopPropagation(); this.closest('.slot-box').remove(); updateCounts();"
                          style="position:absolute; top:0; right:2px; color:red; cursor:pointer; padding:5px;">Ã—</span>` : ''}
            </div>
            <div class="drop-zone" 
                 data-active="true" 
                 data-date="${dateStr}" 
                 data-shift="${shift}" 
                 data-dr="${drName}" 
                 data-pos="${pos}">${defaultTag}</div>
        </div>
    `;
}

    function renderStaffPool() {
        const pool = document.getElementById('staffPool');
        const assistants = appData.employees.slice(1).filter(e => e[2] === "åŠ©ç†");
        const selectedDate = document.getElementById('mondayPicker').value;

        pool.innerHTML = assistants.map(a => {
            const leaveType = checkStaffLeave(a[0], selectedDate, 'å…¨å¤©');
            const staffColor = getStaffColor(a[0]);
            return `
                <div class="staff-item" data-id="${a[0]}" style="border-left: 6px solid ${staffColor} ;">
                    <div class="staff-header">
                        <div>
                            <strong>${a[1]}</strong>
                            ${leaveType ? `<span class="leave-warn">ä¼‘:${leaveType}</span>` : ''}
                        </div>
                        <div class="count-row" style="text-align:right">
                            <span class="count-badge bg-neutral" id="month-count-${a[0]}">M:?</span>
                            <span class="count-badge" id="week-count-${a[0]}">W:0</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        new Sortable(pool, { group: { name: 'shared', pull: 'clone', put: false }, animation: 150,
delay: 200,      // æŒ‰ä½ 200 æ¯«ç§’å¾Œæ‰è§¸ç™¼æ‹–æ›³ï¼Œè®“æ‰‹æŒ‡å¿«é€Ÿæ»‘éæ™‚èƒ½é †åˆ©æ»¾å‹•æ²è»¸
    delayOnTouchOnly: true, // åªåœ¨æ‰‹æ©Ÿç«¯å¥—ç”¨å»¶é²
		sort: false });
    }

    // --- æ‹–æ”¾é‚è¼¯ ---

    function initSortable() { document.querySelectorAll('.drop-zone').forEach(el => initSortableOnElement(el)); }
    
    function initSortableOnElement(el) {
        if (!el || el.dataset.active !== "true") return;
        const s = new Sortable(el, {
            group: 'shared', 
            animation: 150, 	
            disabled: isReadOnly,
			delay: 200,
        delayOnTouchOnly: true,
            onAdd: (evt) => {
                const id = evt.item.dataset.id;
                const date = el.dataset.date;
                const shift = el.dataset.shift;
                const name = evt.item.querySelector('strong')?.innerText || evt.item.innerText.replace('Ã—', '').trim();

                // 1. é‡è¤‡æ’ç­åµæ¸¬
                const allZonesInShift = document.querySelectorAll(`.drop-zone[data-date="${date}"][data-shift="${shift}"]`);
                let existsElsewhere = false;
                allZonesInShift.forEach(zone => {
                    if (zone !== el && zone.querySelector(`[data-id="${id}"]`)) existsElsewhere = true;
                    if (zone === el && zone.querySelectorAll(`[data-id="${id}"]`).length > 1) existsElsewhere = true;
                });

                if (existsElsewhere) {
                    alert(`è­¦å‘Šï¼š${name} åœ¨ ${date} ${shift}è¨º å·²ç¶“æ’éç­äº†ï¼`);
                    evt.item.remove();
                    updateCounts();
                    return;
                }

                // 2. è«‹å‡åµæ¸¬
                const leaveInfo = checkStaffLeave(id, date, shift); 
                if (leaveInfo) {
                    alert(`é˜²å‘†ï¼š${name} åœ¨ ${date} æœ‰è«‹å‡è¨­å®š (${leaveInfo})ï¼`);
                    evt.item.remove();
                    updateCounts();
                    return;
                }

                // 3. æ¨£å¼è½‰æ›ï¼šæ‹–å…¥æ™‚è¨­å®šèƒŒæ™¯é¡è‰²
                if (evt.item.classList.contains('staff-item')) {
                    const staffColor = getStaffColor(id);
                    evt.item.className = 'staff-tag';
                    evt.item.style.cssText = `background-color: ${staffColor} ; color: white ; border: none ;`;
                    evt.item.innerHTML = `${name} <span class="remove" 
    onclick="event.stopPropagation(); this.parentElement.remove(); updateCounts();" 
    ontouchend="event.stopPropagation(); this.parentElement.remove(); updateCounts();"
    style="padding: 2px 8px;">Ã—</span>`;
                }
                updateCounts();
            },
            onEnd: updateCounts
        });
        sortables.push(s);
    }

    // --- è³‡æ–™å¡«å……èˆ‡å­˜æª” ---

    function fillExistingData() {
        if (!appData.liveSchedule || appData.liveSchedule.length <= 1) return;
        const empMap = {}; appData.employees.forEach(e => empMap[e[0]] = e[1]);
        appData.liveSchedule.slice(1).forEach(row => {
            const date = formatDate(row[0]), shift = row[1], id = row[2], pos = row[3], dr = row[4];
            let zone = document.querySelector(`.drop-zone[data-date="${date}"][data-shift="${shift}"][data-pos="${pos}"][data-dr="${dr}"]`);
            if (!zone && pos === "åŠ è¨ºé†«å¸«") {
                addExtraSlot(0, shift, date, dr, "åŠ è¨ºé†«å¸«", true);
                zone = document.querySelector(`.drop-zone[data-date="${date}"][data-shift="${shift}"][data-pos="${pos}"][data-dr="${dr}"]`);
            }
            if (zone && id) {
                const staffColor = getStaffColor(id);
                const tag = document.createElement('div'); 
                tag.className='staff-tag'; 
                tag.dataset.id=id; 
                tag.style.cssText = `background-color: ${staffColor} ; color: white ; border: none ;`;
                tag.innerHTML = `${empMap[id] || id} ${!isReadOnly ? `
    <span class="remove" 
          onclick="event.stopPropagation(); this.parentElement.remove(); updateCounts();" 
          ontouchend="event.stopPropagation(); this.parentElement.remove(); updateCounts();"
          style="padding: 2px 8px;">Ã—</span>` : ''}`;
                zone.appendChild(tag);
            }
        });
        updateCounts();
    }

    async function saveSchedule() {
        if(isReadOnly) return;
        const data = [];
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.querySelectorAll('.staff-tag').forEach(tag => {
                data.push({ 
                    date: zone.dataset.date, shift: zone.dataset.shift, 
                    dr: zone.dataset.dr, pos: zone.dataset.pos, empId: tag.dataset.id 
                });
            });
        });
        if(data.length === 0 && !confirm("ç›®å‰æ²’æœ‰æ’ä»»ä½•ç­ï¼Œç¢ºå®šè¦ç™¼ä½ˆå—ï¼Ÿ")) return;
        if(!confirm("ç¢ºå®šç™¼ä½ˆæœ¬é€±ç­è¡¨ï¼Ÿ")) return;
        showLoading(true);
        try {
            const res = await fetch(webAppUrl, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "saveWeeklySchedule", 
                    targetMonday: document.getElementById('mondayPicker').value, 
                    data, operator: currentUser.name 
                }) 
            });
            const result = await res.json();
            alert(result.message);
            fetchData();
        } catch(e) { alert("å„²å­˜å¤±æ•—"); }
        finally { showLoading(false); }
    }

    // --- å¿«ç…§èˆ‡ç‰ˆæœ¬ç®¡ç† ---

    function loadDataIntoUI(data) {
        document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = '');
        const empMap = {}; appData.employees.forEach(e => empMap[e[0]] = e[1]);
        const currentWeekDates = appData.weekDates.map(d => formatDate(d));

        data.forEach(item => {
            const sDate = new Date(item.date);
            const sDay = sDate.getDay() || 7; 
            const tDate = currentWeekDates[sDay - 1];
            let target = document.querySelector(`.drop-zone[data-date="${tDate}"][data-shift="${item.shift}"][data-dr="${item.dr}"][data-pos="${item.pos}"]`);
            if(!target && item.pos === "åŠ è¨ºé†«å¸«") {
                addExtraSlot(sDay, item.shift, tDate, item.dr, "åŠ è¨ºé†«å¸«", true);
                target = document.querySelector(`.drop-zone[data-date="${tDate}"][data-shift="${item.shift}"][data-dr="${item.dr}"][data-pos="${item.pos}"]`);
            }
            if(target) {
                const staffColor = getStaffColor(item.empId);
                const tag = document.createElement('div'); 
                tag.className='staff-tag'; 
                tag.dataset.id = item.empId;
                tag.style.cssText = `background-color: ${staffColor} ; color: white ; border: none ;`;
                tag.innerHTML = `${empMap[item.empId] || item.empId} ${!isReadOnly ? `
    <span class="remove" 
          onclick="event.stopPropagation(); this.parentElement.remove(); updateCounts();"
          ontouchend="event.stopPropagation(); this.parentElement.remove(); updateCounts();">Ã—</span>` : ''}`;
                target.appendChild(tag);
            }
        });
        updateCounts();
    }

    async function fetchSnapshots(targetMonday) {
        try {
            const res = await fetch(webAppUrl, { method: "POST", body: JSON.stringify({ action: "getSnapshots", targetMonday: targetMonday }) });
            const snapshots = await res.json();
            const displayList = [...snapshots].reverse();
            const snapshotsWithV = displayList.map((s, idx) => ({ ...s, vName: `V${idx+1}` }));
            snapshotsWithV.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const container = document.getElementById('verButtons');
            container.innerHTML = snapshotsWithV.map(s => `
                <button class="ver-btn" onclick='viewSnapshot(${JSON.stringify(s.content)}, "${s.timestamp}")'>
                    ${s.vName}: ${new Date(s.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </button>
            `).join('') || '<span style="font-size:11px; color:#999;">æš«ç„¡å¿«ç…§</span>';
        } catch(e) { console.error("å¿«ç…§æŠ“å–å¤±æ•—", e); }
    }

    async function openCopyModal() {
        showLoading(true);
        try {
            const res = await fetch(webAppUrl, { method: "POST", body: JSON.stringify({ action: "getAllWeeksLastSnapshots" }) });
            const list = await res.json();
            const container = document.getElementById('copyVersionList');
            container.innerHTML = list.map(s => `
                <button class="btn-main" style="background:#f8f9fa; color:#333; border:1px solid #ddd; text-align:left; margin-bottom:8px;" 
                    onclick='applyCopy(${JSON.stringify(s.content)})'>
                    ğŸ“… ${s.monday} æœ€çµ‚ç‰ˆæœ¬
                </button>
            `).join('') || 'ç„¡æ­·å²ç‰ˆæœ¬';
            document.getElementById('copyModal').style.display = 'flex';
        } finally { showLoading(false); }
    }

    function applyCopy(content) {
        if(!confirm("é€™å°‡è¦†è“‹ç›®å‰ç·¨è¼¯ä¸­çš„å…§å®¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        document.getElementById('copyModal').style.display = 'none';
        isReadOnly = false;
        toggleViewMode(false);
        renderSchedule(); 
        const data = typeof content === 'string' ? JSON.parse(content) : content;
        loadDataIntoUI(data);
    }

    function viewSnapshot(content, ts) {
        isReadOnly = true;
        toggleViewMode(true, ts);
        renderSchedule(); 
        const data = typeof content === 'string' ? JSON.parse(content) : content;
        loadDataIntoUI(data);
    }

    // --- UI åˆ‡æ›èˆ‡å…¶ä»–åŠŸèƒ½ ---

    function updateCounts() {
        const counts = {};
        document.querySelectorAll('.drop-zone .staff-tag').forEach(t => { if(t.dataset.id) counts[t.dataset.id] = (counts[t.dataset.id] || 0) + 1; });
        appData.employees.slice(1).forEach(a => {
            const empId = a[0], wBadge = document.getElementById(`week-count-${empId}`), mBadge = document.getElementById(`month-count-${empId}`);
            const currentWeekUI = counts[empId] || 0;
            if(wBadge) {
                wBadge.innerText = `W:${currentWeekUI}`;
                wBadge.className = 'count-badge ' + (currentWeekUI >= 10 ? 'bg-danger' : (currentWeekUI > 0 ? 'bg-safe' : 'bg-neutral'));
            }
            if(mBadge) {
                const initialMonth = appData.monthStats[empId] || 0, savedInThisWeek = appData.thisWeekSavedCounts[empId] || 0;
                mBadge.innerText = `M:${(initialMonth - savedInThisWeek) + currentWeekUI}`;
            }
        });
    }

    function toggleViewMode(readOnly, ts) {
        const body = document.getElementById('appBody'), banner = document.getElementById('viewBanner');
        const btnSave = document.getElementById('btnSave'), btnExit = document.getElementById('btnExitView');
        if(readOnly) {
            body.classList.add('read-only-mode');
            banner.style.display = 'block';
            banner.innerText = `âš ï¸ æ­·å²å¿«ç…§ (${new Date(ts).toLocaleString()})`;
            btnSave.style.display = 'none'; btnExit.style.display = 'block';
        } else {
            body.classList.remove('read-only-mode');
            banner.style.display = 'none';
            btnSave.style.display = 'block'; btnExit.style.display = 'none';
        }
    }

    function handleDayClick(el) {
        if(window.innerWidth > 768) return;
		// 2. æ ¸å¿ƒä¿®æ­£ï¼šåˆ¤æ–·é»æ“Šçš„ä¾†æº
    // å¦‚æœé»æ“Šçš„æ˜¯ X (remove) æˆ–è€… æ¨™ç±¤æœ¬èº« (staff-tag)ï¼Œå°±è·³éæ”¶åˆå‹•ä½œ
    if (event.target.classList.contains('remove') || 
        event.target.classList.contains('staff-tag')) {
        return; 
    }		
        document.querySelectorAll('.day-column').forEach(c => { if(c !== el) c.classList.remove('active'); });
        el.classList.toggle('active');
    }

    function addExtraSlot(day, shift, dateStr, drName, pos, isExtra) {
        const container = document.querySelector(`.shift-section[data-date="${dateStr}"][data-shift="${shift}"] .slot-container`);
        if(!container) return;
        const div = document.createElement('div');
        div.innerHTML = createSlotHTML(drName, pos, false, null, dateStr, day, shift, isExtra);
        const element = div.firstElementChild;
        container.appendChild(element);
        initSortableOnElement(element.querySelector('.drop-zone'));
    }

    function addExtraSlotPrompt(day, shift, dateStr) {
        if(isReadOnly) return;
        const dr = prompt("è«‹è¼¸å…¥åŠ è¨ºé†«å¸«å§“å:"); 
        if(dr && dr.trim() !== "") addExtraSlot(day, shift, dateStr, dr.trim(), "åŠ è¨ºé†«å¸«", true);
    }

    function renderDayLeaves(dateStr) {
        const list = appData.staffLeaves ? appData.staffLeaves.slice(1).filter(l => formatDate(l[2]) === dateStr) : [];
        return `<div class="leave-title">åŠ©ç†ä¼‘å‡</div>` + 
               (list.length ? list.map(l => {
                   return `<div class="leave-item"><b>${l[1]}</b> (${l[3]}:${l[4]})</div>`;
               }).join('') : '<div class="leave-item" style="color:#ccc;">ç„¡</div>');
    }
	
	
	// é¡¯ç¤ºé¸æ“‡è¦–çª—
function showImageOptions() {
    document.getElementById('printOptionModal').style.display = 'flex';
}

// åŸ·è¡Œç”¢åœ–ä¸¦é—œé–‰è¦–çª—
function execPrint(mode) {
    document.getElementById('printOptionModal').style.display = 'none';
    generateA4ScheduleImage(mode); // å‘¼å«åŸæœ¬å¯«å¥½çš„å‡½å¼
}


async function generateA4ScheduleImage(mode = 'color') {
    showLoading(true, `æ­£åœ¨ç¹ªè£½ ${mode === 'color' ? 'å½©è‰²' : 'é»‘ç™½'} åœ–å¡...`);

    const renderArea = document.createElement('div');
    renderArea.id = "hiddenRenderArea";
    document.body.appendChild(renderArea);

    let html = `<div class="a4-print-canvas" id="captureTarget">`;
    
    const days = document.querySelectorAll('.day-column');
    days.forEach(day => {
        const dayName = day.querySelector('.day-header').innerText.replace('â–¼','').replace('â–²','').trim();
        html += `<div class="print-col">
            <div class="print-day-header">${dayName}</div>`;

        const dayContent = day.innerHTML;
        if (dayContent.includes("æœ¬æ—¥ä¼‘è¨º")) {
            html += `<div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                <div style="border: 2px dashed #adb5bd; color: #adb5bd; padding: 15px; border-radius: 10px; text-align: center; width: 80%;">
                    <div style="font-size: 24px;">ğŸ¨ æœ¬æ—¥ä¼‘è¨º</div>
                </div>
            </div>`;
        } else {
            const shifts = day.querySelectorAll('.shift-section');
            shifts.forEach(shift => {
                const shiftTitle = shift.querySelector('.shift-title').innerText.replace('+ åŠ è¨º','').trim();
                const isShiftClosed = shift.innerText.includes("ä¼‘è¨º");

                html += `<div class="print-shift-section">
                    <div class="print-shift-title">${shiftTitle}</div>`;
                
                if (isShiftClosed) {
                    html += `<div style="color: #adb5bd; text-align: center; font-size: 12px;">ğŸ  ä¼‘è¨º</div>`;
                } else {
                    const slots = shift.querySelectorAll('.slot-box');
                    slots.forEach(slot => {
                        const drSpan = slot.querySelector('.dr-name-label span');
                        const drName = drSpan ? drSpan.innerText : "æœªå®š";
                        
                        const drLeaveNote = slot.querySelector('.dr-leave-note');
                        let leaveHtml = drLeaveNote ? `<div style="color: #d63031; font-size: 10px; font-weight: bold;">âš ï¸ ${drLeaveNote.innerText.trim()}</div>` : "";

                        // --- æ ¸å¿ƒæ”¹å‹•ï¼šæ ¹æ“šæ¨¡å¼æ±ºå®šåŠ©ç†æ¨™ç±¤æ¨£å¼ ---
                        const staffListHtml = Array.from(slot.querySelectorAll('.staff-tag'))
                            .map(s => {
                                const name = s.childNodes[0].textContent.trim();
                                if (!name) return '';
                                
                                if (mode === 'color') {
                                    // å½©è‰²æ¨¡å¼ï¼šæŠ“å–åŸå§‹èƒŒæ™¯è‰²
                                    const bgColor = window.getComputedStyle(s).backgroundColor;
                                    return `<span style="background-color: ${bgColor} !important; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 3px; font-size: 11px; display: inline-block;">${name}</span>`;
                                } else {
                                    // é»‘ç™½æ¨¡å¼ï¼šå»èƒŒæ™¯ï¼Œæ”¹ç”¨é‚Šæ¡†æˆ–æ‹¬è™Ÿ
                                    return `<span style="background: none !important; color: #333; border: 1px solid #ccc; padding: 1px 4px; border-radius: 3px; margin-left: 3px; font-size: 11px; display: inline-block;">${name}</span>`;
                                }
                            }).join('');

                        html += `<div class="print-slot" style="margin-bottom: 4px; padding: 3px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                            ${leaveHtml}
                            <b style="color:#333; font-size: 13px;">${drName}</b> ${staffListHtml}
                        </div>`;
                    });
                }
                html += `</div>`;
            });
        }
        
        // åº•éƒ¨åŠ©ç†ä¼‘å‡ (é»‘ç™½æ¨¡å¼ä¸‹ä¹Ÿå¾®èª¿æ¨£å¼)
        const leavesHtml = day.querySelector('.day-leave-area').innerHTML;
        const leaveBg = mode === 'color' ? '#fff9db' : '#ffffff';
        html += `<div style="padding:8px; font-size:11px; background:${leaveBg}; border-top: 1px solid #ddd;">${leavesHtml}</div>`;
        html += `</div>`;
    });
    html += `</div>`;

    renderArea.innerHTML = html;

    try {
        const target = document.getElementById('captureTarget');
        const canvas = await html2canvas(target, { scale: 2, useCORS: true, width: 1123, height: 794 });

        const container = document.getElementById('canvasContainer');
        container.innerHTML = '';
        const img = new Image();
        img.src = canvas.toDataURL("image/png");
        img.style.width = "100%";
        container.appendChild(img);
        document.getElementById('imagePreviewModal').style.display = 'flex';
        
        document.getElementById('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.download = `è¨ºæ‰€ç­è¡¨_${mode}_${document.getElementById('mondayPicker').value}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        };
    } catch (e) {
        console.error(e);
        alert("ç”¢åœ–å¤±æ•—");
    } finally {
        document.body.removeChild(renderArea);
        showLoading(false);
    }
}

    // --- åˆå§‹åŒ– ---

    window.onload = function() {
        console.log("ç³»çµ±å•Ÿå‹•ä¸­...");
        const urlParams = new URLSearchParams(window.location.search);
        const empId = urlParams.get('empId');
        const name = urlParams.get('name');
        const role = urlParams.get('role');

        if (!empId || (role !== "ä¸»ç®¡" && role !== "Admin")) {
            alert("æ¬Šé™ä¸è¶³ï¼Œå°‡è¿”å›ä¸»é¸å–®");
            window.location.href = "index.html";
            return;
        }

        currentUser = { empId, name, role };
        const infoDiv = document.getElementById('adminInfo');
        if (infoDiv) infoDiv.innerText = "ç®¡ç†è€…: " + name;

        initSystem();
    };
</script>
</body>
</html>
