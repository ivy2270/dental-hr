<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äºº/å…¨é™¢ç­è¡¨æŸ¥è©¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        :root { 
            --primary: #007bff; --success: #28a745; --error: #dc3545; --border: #dee2e6; 
            --morning: #007bff; --afternoon: #28a745; --evening: #fd7e14;
            --bg: #f0f2f5;
        }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; }
        .header { background: white; padding: 12px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-container { display: flex; gap: 8px; background: #f8f9fa; padding: 5px; border-radius: 12px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: #666; background: none; font-size: 0.95em; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .nav-btn { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; cursor: pointer; }
        #dateDisplay { font-weight: bold; font-size: 0.9em; flex-grow: 1; text-align: center; }
        
        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        #weekPicker { border: 1px solid var(--border); padding: 5px; border-radius: 6px; font-size: 0.9em; }

        /* --- å€‹äººæœˆæ›† --- */
        .calendar-wrapper { width: 100%; overflow-x: auto; padding: 5px; }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            min-width: 320px; 
            background: #eee; gap: 1px; border: 1px solid var(--border); border-radius: 8px; 
        }
        .calendar-day-head { background: #f8f9fa; padding: 8px 0; text-align: center; font-size: 0.75em; font-weight: bold; }
        .calendar-day { background: white; min-height: 80px; padding: 2px; }
        .day-num { font-size: 0.8em; font-weight: bold; margin-bottom: 2px; }
        
        .shift-tag { font-size: 9px; padding: 1px 2px; border-radius: 3px; color: white; margin-bottom: 2px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tag-m { background: var(--morning); }
        .tag-a { background: var(--afternoon); }
        .tag-e { background: var(--evening); }
        .tag-leave { background: white; border: 1px solid var(--error); color: var(--error); font-weight: bold; }

        /* --- å…¨é™¢é€±è¡¨ --- */
        .day-card { background: white; margin: 10px; border-radius: 10px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .day-header { padding: 12px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; cursor: pointer; }
        .day-header.is-holiday { border-left: 5px solid var(--error); }
        .day-content { padding: 0; display: none; }
        .shift-box { padding: 10px; border-bottom: 1px dotted #eee; }
        .shift-title { font-size: 0.85em; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; color: #555; }
        .shift-title::before { content: ""; width: 8px; height: 8px; border-radius: 2px; margin-right: 6px; }
        .title-m::before { background: var(--morning); }
        .title-a::before { background: var(--afternoon); }
        .title-e::before { background: var(--evening); }
        
        .staff-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .staff-tag { background: #f8f9fa; border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 0.85em; display: flex; align-items: center; }
        .pos-sub { font-size: 0.75em; color: #ffffff; margin-right: 5px; background: #495057; padding: 1px 4px; border-radius: 3px; }
        
        .dr-leave { background: #fff5f5; color: var(--error); padding: 8px; border-radius: 6px; font-size: 0.8em; margin-bottom: 8px; border: 1px dashed var(--error); font-weight: bold; }
        .footer-leave { background: #fafafa; padding: 10px; font-size: 0.75em; color: #777; border-top: 1px solid #eee; }
        
        .hidden { display: none; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loading">è®€å–ç­è¡¨ä¸­...</div>

<div class="header">
<div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px;">
        <button onclick="goBackMenu()" style="border: 1px solid var(--border); background: white; border-radius: 8px; padding: 6px 12px; cursor: pointer; font-size: 14px; display: flex; align-items: center;">
            ğŸ  è¿”å›ä¸»é¸å–®
        </button>
        <span style="font-size: 14px; font-weight: bold; color: #333;">ç­è¡¨æŸ¥è©¢ç³»çµ±</span>
    </div>
    <div class="tab-container">
        <button id="btnP" class="tab-btn active" onclick="switchTab('personal')">ğŸ™‹ å€‹äººæœˆæ›†</button>
        <button id="btnC" class="tab-btn" onclick="switchTab('clinic')">ğŸ¥ å…¨é™¢é€±è¡¨</button>
    </div>
    
    <div class="control-bar" id="pCtrl">
        <button class="nav-btn" onclick="moveMonth(-1)">â—€</button>
        <div id="dateDisplay"></div>
        <button class="nav-btn" onclick="moveMonth(1)">â–¶</button>
    </div>

    <div class="control-bar hidden" id="cCtrl">
        <span style="font-size:0.8em; color:#666;">é¸æ“‡é€±ä¸€:</span>
        <input type="date" id="weekPicker" onchange="handleWeekChange()">
    </div>
</div>

<div id="pSec">
    <div class="calendar-wrapper"><div class="calendar-grid" id="calGrid"></div></div>
</div>

<div id="cSec" class="hidden">
    <div id="weekList"></div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxIzIUEMUkN2iWjKnYbdq-6znGrxFF7gajztQnSrsWto9BeeT-c98yooTk75OPMP7Qitw/exec"; 
    let params = new URLSearchParams(window.location.search);
    let user = { empId: params.get('empId') };
    let curDate = new Date(); // å€‹äººæœˆæ›†ç”¨
    let curMonStr = "";       // å…¨é™¢é€±è¡¨ç”¨ (YYYY-MM-DD)

    window.onload = () => { 
        if(!user.empId) return alert("è«‹é‡ç™»");
        // åˆå§‹åŒ–é€±ä¸€æ—¥æœŸ
        const today = new Date();
        const diff = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1);
        const monday = new Date(today.setDate(diff));
        curMonStr = monday.toISOString().split('T')[0];
        document.getElementById('weekPicker').value = curMonStr;
        
        fetchData(); 
    };
	
	function goBackMenu() {
    const urlParams = new URLSearchParams(window.location.search);
    const empId = urlParams.get('empId');
    const name = urlParams.get('name');
    const role = urlParams.get('role');
    
    // å‡è¨­æ‚¨çš„ä¸»é¸å–®æª”æ¡ˆåç‚º menu.html
    window.location.href = `index.html?empId=${empId}&name=${encodeURIComponent(name)}&role=${encodeURIComponent(role)}`;
}
	
	function toIsoDate(dateStr) {
    if (!dateStr) return "";
    // è™•ç† Date ç‰©ä»¶æˆ–å­—ä¸²ï¼Œçµ±ä¸€è½‰ç‚º YYYY-MM-DD
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) {
        // å¦‚æœæ˜¯å­—ä¸² 2026/4/3 é€™ç¨®ï¼Œæ‰‹å‹•è£œ0
        const parts = dateStr.replace(/\//g, '-').split('-');
        return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
    }
    return d.toISOString().split('T')[0];
}

    function switchTab(t) {
        $('.tab-btn').removeClass('active');
        t === 'personal' ? $('#btnP').addClass('active') : $('#btnC').addClass('active');
        $('#pSec').toggleClass('hidden', t!=='personal');
        $('#cSec').toggleClass('hidden', t!=='clinic');
        $('#pCtrl').toggleClass('hidden', t!=='personal');
        $('#cCtrl').toggleClass('hidden', t!=='clinic');
    }

    function moveMonth(s) {
        curDate.setMonth(curDate.getMonth() + s);
        fetchData();
    }

    function handleWeekChange() {
        // ç¢ºä¿é¸æ“‡çš„æ˜¯é€±ä¸€ (é˜²å‘†)
        let d = new Date(document.getElementById('weekPicker').value);
        let day = d.getDay();
        if(day !== 1) {
            let diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            document.getElementById('weekPicker').value = d.toISOString().split('T')[0];
        }
        curMonStr = document.getElementById('weekPicker').value;
        fetchData();
    }

    async function fetchData() {
        $('#loading').show();
        const m = `${curDate.getFullYear()}-${String(curDate.getMonth()+1).padStart(2,'0')}`;
        try {
            const r = await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "getStaffScheduleData", 
                    empId: user.empId, 
                    month: m, 
                    monday: curMonStr 
                }) 
            });
            const res = await r.json();
            if(res.status === "success") {
                $('#dateDisplay').text(`${curDate.getFullYear()}å¹´ ${curDate.getMonth()+1}æœˆ`);
                renderCal(res);
                renderClinic(res);
            }
        } catch(e) { console.error(e); } finally { $('#loading').hide(); }
    }

function renderCal(data) {
    const g = $('#calGrid').empty();
    ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].forEach(d => g.append(`<div class="calendar-day-head">${d}</div>`));
    let y = curDate.getFullYear(), m = curDate.getMonth();
    let start = new Date(y, m, 1).getDay(); if(start === 0) start = 7;
    for(let i=1; i<start; i++) g.append(`<div class="calendar-day" style="background:#f9f9f9"></div>`);
    
    let days = new Date(y, m+1, 0).getDate();
    for(let d=1; d<=days; d++) {
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hol = data.holidays.find(h => toIsoDate(h.date) === ds);
        let h = `<div class="calendar-day"><div class="day-num" style="${hol?'color:red':''}">${d}</div>`;
        
        // --- ä¿®æ”¹é€™è£¡ï¼šé¡¯ç¤º è¨ºæ¬¡ + å‡åˆ¥ ---
        data.staffLeaves.filter(l => l.date === ds).forEach(l => {
            // l.shift[0] å–ç¬¬ä¸€å€‹å­—(æ—©/åˆ/æ™š)ï¼Œl.type æ˜¯å‡åˆ¥(ç—…/äº‹/ç‰¹)
            h += `<span class="shift-tag tag-leave">ä¼‘:${l.shift[0]}|${l.type}</span>`;
        });
        
        data.personal.filter(p => p.date === ds).forEach(p => {
            let c = p.shift.includes('æ—©')?'tag-m':(p.shift.includes('åˆ')?'tag-a':'tag-e');
            h += `<span class="shift-tag ${c}">${p.shift[0]}:${p.label}</span>`;
        });
        g.append(h + `</div>`);
    }
}

    function renderClinic(data) {
        const list = $('#weekList').empty();
        const names = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        
        // ç›´æ¥ä½¿ç”¨ GAS å›å‚³çš„ç•¶é€±æ—¥æœŸåˆ—è¡¨ (weekDates)
        data.weekDates.forEach((ds, idx) => {
            const d = new Date(ds);
            const hol = data.holidays.find(h => toIsoDate(h.date) === ds);
            
            let h = `<div class="day-card">
                <div class="day-header ${hol?'is-holiday':''}" onclick="$(this).next().slideToggle(150)">
                    <div>${d.getMonth()+1}/${d.getDate()} (${names[d.getDay()]}) ${hol?hol.name:''}</div>
                    <div style="font-size:0.75em; color:var(--primary);">å±•é–‹ â–¼</div>
                </div>
                <div class="day-content">`;
            
            ['æ—©è¨º','åˆè¨º','æ™šè¨º'].forEach(sh => {
                let c = sh==='æ—©è¨º'?'title-m':(sh==='åˆè¨º'?'title-a':'title-e');
                h += `<div class="shift-box"><div class="shift-title ${c}">${sh}</div>`;
                
                // é†«å¸«è«‹å‡
                data.drLeaves.filter(v => v.date === ds && (v.shift === sh || v.shift === 'å…¨å¤©'))
                    .forEach(v => h += `<div class="dr-leave">âš ï¸ ${v.name} é†«å¸«è«‹å‡ (${v.type})</div>`);
                
                // åŠ©ç†æ’ç­ (å…¨é™¢)
                const ss = data.clinic.filter(v => v.date === ds && v.shift.includes(sh[0]));
                if(ss.length) {
                    h += `<div class="staff-list">`;
                    ss.forEach(s => h += `<div class="staff-tag"><span class="pos-sub">${s.label}</span><b>${s.empName}</b></div>`);
                    h += `</div>`;
                } else h += `<div style="color:#ccc; font-size:0.8em; padding:5px;">ç„¡æ’ç­</div>`;
                
                h += `</div>`;
            });
            
            // è©²æ—¥ä¼‘å‡åŠ©ç†
            const lv = data.allStaffLeaves.filter(v => v.date === ds);
            if(lv.length) {
    // é€™è£¡æœƒé¡¯ç¤ºä¾‹å¦‚ï¼š æŸæŸæŸ (æ—©è¨º:ç—…å‡)
    h += `<div class="footer-leave">ğŸš« åŠ©ç†ä¼‘å‡ï¼š${lv.map(v => `<b>${v.name}</b>(${v.shift}:${v.type})`).join('ã€')}</div>`;
}
            
            list.append(h + `</div></div>`);
        });
        // é è¨­å±•é–‹ä»Šæ—¥æˆ–ç¬¬ä¸€å¤©
        $('.day-card').first().find('.day-content').show();
    }
</script>
</body>
</html>